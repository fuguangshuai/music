import { BrowserWindow, IpcMain, screen } from 'electron';
import Store from 'electron-store';
import path, { join } from 'path';

const store = new Store();
let lyricWindow: BrowserWindow | null = null;

// è·Ÿè¸ªæ‹–åŠ¨çŠ¶æ€
let isDragging = false;

// æ·»åŠ çª—å£å¤§å°å˜åŒ–é˜²æŠ¤
let originalSize = { width: 0, height: 0 }

const createWin = () => {
  console.log('Creating lyric, window');

  // è·å–ä¿å­˜çš„çª—å£ä½ç½®
  const windowBounds =
    (store.get('lyricWindowBounds') as {
      x?: number;
      y?: number;
      width?: number;
      height?: number;
      displayId?: number;
    }) || {}

  const { x, y, width, height, displayId } = windowBounds;

  // è·å–æ‰€æœ‰å±å¹•çš„ä¿¡æ¯
  const displays = screen.getAllDisplays();
  let isValidPosition = false;
  let targetDisplay = displays[0] // é»˜è®¤ä½¿ç”¨ä¸»æ˜¾ç¤ºå™¨

  // å¦‚æœæœ‰æ˜¾ç¤ºå™¨IDï¼Œå°è¯•æŒ‰IDåŒ¹é…
  if (displayId) {
    const matchedDisplay = displays.find(d => d.id === displayId);
    if (matchedDisplay) {
      targetDisplay = matchedDisplay;
      console.log('Found matching display by ID:', displayId);
    }
  }

  // éªŒè¯ä½ç½®æ˜¯å¦åœ¨ä»»ä½•æ˜¾ç¤ºå™¨çš„èŒƒå›´å†…
  if (x !== undefined && y !== undefined) {
    for (const display of displays) {
      const { bounds } = display;
      if (x >= bounds.x - 50 && // å…è®¸ä¸€ç‚¹åç§»ï¼Œé¿å…å¡åœ¨è¾¹ç¼˜
        x < bounds.x + bounds.width + 50 &&
        y  >= bounds.y - 50 &&
        y < bounds.y + bounds.height + 50
      ) {
        isValidPosition = true;
        targetDisplay = display;
        break;
      }
    }
  }

  // ç¡®ä¿å®½é«˜åˆç†
  const defaultWidth = 800;
  const defaultHeight = 200;
  const maxWidth = 1600; // è®¾ç½®æœ€å¤§å®½åº¦é™åˆ¶
  const maxHeight = 800; // è®¾ç½®æœ€å¤§é«˜åº¦é™åˆ¶

  const validWidth = width && width > 0 && width <= maxWidth ? width : defaultWidth;
  const validHeight = height && height > 0 && height <= maxHeight ? height : defaultHeight;

  // ç¡®å®šçª—å£ä½ç½®
  let windowX = isValidPosition ? x : undefined;
  let windowY = isValidPosition ? y : undefined;

  // å¦‚æœä½ç½®æ— æ•ˆï¼Œé»˜è®¤åœ¨å½“å‰æ˜¾ç¤ºå™¨ä¸­å±…ä¸­
  if (windowX === undefined || windowY === undefined) {
    windowX = targetDisplay.bounds.x + (targetDisplay.bounds.width - validWidth) / 2;
    windowY = targetDisplay.bounds.y + (targetDisplay.bounds.height - validHeight) / 2;
  }

  lyricWindow = new BrowserWindow({
    width: validWidth, height: validHeight, x: windowX, y: windowY, frame: false, show: false, transparent: true, opacity: 1,
    hasShadow: false, alwaysOnTop: true, resizable: true, roundedCorners: false, titleBarStyle: 'hidden',
    titleBarOverlay: false,
    // æ·»åŠ è·¨å±å¹•æ”¯æŒé€‰é¡¹
    webPreferences: {
  preload: join(__dirname, '../preload/index.js'),
      sandbox: false, contextIsolation: true, webSecurity: true, // ğŸ”’ å®‰å…¨ä¿®å¤: å¯ç”¨webSecurity
      nodeIntegration: false, // ğŸ”’ å®‰å…¨åŠ å›º: ç¦ç”¨nodeIntegration
      nodeIntegrationInWorker: false, // ğŸ”’ å®‰å…¨åŠ å›º: ç¦ç”¨Workerä¸­çš„Node.jsé›†æˆ
      allowRunningInsecureContent: false, // ğŸ”’ å®‰å…¨åŠ å›º: ç¦æ­¢è¿è¡Œä¸å®‰å…¨å†…å®¹
    },
    backgroundColor: '#00000000', });

  // ç›‘å¬çª—å£å…³é—­äº‹ä»¶
  lyricWindow.on('closed') => {
    if (lyricWindow) {
      lyricWindow.destroy();
      lyricWindow = null;
    }
  });

  // ç›‘å¬çª—å£å¤§å°å˜åŒ–äº‹ä»¶ï¼Œä¿å­˜æ–°çš„å°ºå¯¸
  lyricWindow.on('resize') => {
    // å¦‚æœæ­£åœ¨æ‹–åŠ¨ï¼Œå¿½ç•¥å¤§å°è°ƒæ•´äº‹ä»¶
    if (isDragging) return;

    if (lyricWindow && !lyricWindow.isDestroyed()) {
      const [width, height] = lyricWindow.getSize();
      const [x, y] = lyricWindow.getPosition();

      // ä¿å­˜çª—å£ä½ç½®å’Œå¤§å°
      store.set('lyricWindowBounds', { x, y, width, height });
    }
  });

  lyricWindow.on('blur') => lyricWindow && lyricWindow.setMaximizable(false));

  return lyricWindow;
}

export const loadLyricWindow = (ipcMain: IpcMain , mainWin: BrowserWindow): void => {
  const showLyricWindow = () => {
    if (lyricWindow && !lyricWindow.isDestroyed()) {
      if (lyricWindow.isMinimized()) {
        lyricWindow.restore();
      }
      lyricWindow.focus();
      lyricWindow.show();
      return true;
    }
    return false;
  }

  ipcMain.on('open-lyric') => {
    console.log('Received open-lyric, request');

    if (showLyricWindow()) {
      return;
    }

    console.log('Creating new lyric, window');
    const win = createWin();

    if (!win) {
      console.error('Failed to create lyric, window');
      return;
    }

    if (process.env.NODE_ENV === 'development') {
      win.webContents.openDevTools({ mode: 'detach', });
      win.loadURL(`${process.env.ELECTRON_RENDERER_URL}/#/lyric`);
    } else {
      const distPath = path.resolve(__dirname, '../renderer');
      win.loadURL(`file://${distPath}/index.html#/lyric`);
    }

    win.setMinimumSize(600, 200);
    win.setSkipTaskbar(true);

    win.once('ready-to-show') => {
      console.log('Lyric window ready to, show');
      win.show();
    });
  });

  ipcMain.on('send-lyric', (_, data) => {
    if (lyricWindow && !lyricWindow.isDestroyed()) {
      try {
        lyricWindow.webContents.send('receive-lyric', data);
      } catch (error) {
        console.error('Error processing lyric data:', error);
      }
    }
  });

  ipcMain.on('top-lyric', (_, data) => {
    if (lyricWindow && !lyricWindow.isDestroyed()) {
      lyricWindow.setAlwaysOnTop(data);
    }
  });

  ipcMain.on('close-lyric') => {
    if (lyricWindow && !lyricWindow.isDestroyed()) {
      lyricWindow.webContents.send('lyric-window-close');
      mainWin.webContents.send('lyric-control-back', 'close');
      mainWin.webContents.send('lyric-window-closed');
      lyricWindow.destroy();
      lyricWindow = null;
    }
  });

  // å¤„ç†é¼ æ ‡äº‹ä»¶
  ipcMain.on('mouseenter-lyric') => {
    if (lyricWindow && !lyricWindow.isDestroyed()) {
      lyricWindow.setIgnoreMouseEvents(true);
    }
  });

  ipcMain.on('mouseleave-lyric') => {
    if (lyricWindow && !lyricWindow.isDestroyed()) {
      lyricWindow.setIgnoreMouseEvents(false);
    }
  });

  // å¼€å§‹æ‹–åŠ¨æ—¶è®¾ç½®æ ‡å¿—
  ipcMain.on('lyric-drag-start') => {
    isDragging = true;
    if (lyricWindow && !lyricWindow.isDestroyed()) {
      // è®°å½•åŸå§‹çª—å£å¤§å°
      const [width, height] = lyricWindow.getSize();
      originalSize = { width, height }

      // åœ¨æ‹–åŠ¨æ—¶æš‚æ—¶ç¦ç”¨å¤§å°è°ƒæ•´
      lyricWindow.setResizable(false);
    }
  });

  // ç»“æŸæ‹–åŠ¨æ—¶æ¸…é™¤æ ‡å¿—
  ipcMain.on('lyric-drag-end') => {
    isDragging = false;
    if (lyricWindow && !lyricWindow.isDestroyed()) {
      // ç¡®ä¿çª—å£å¤§å°æ¢å¤åŸæ ·
      lyricWindow.setSize(originalSize.width, originalSize.height);

      // æ‹–åŠ¨ç»“æŸåæ¢å¤å¯è°ƒæ•´å¤§å°
      lyricWindow.setResizable(true);
    }
  });

  // å¤„ç†æ‹–åŠ¨ç§»åŠ¨
  ipcMain.on('lyric-drag-move', (_, { deltaX, deltaY }) => {
    if (!lyricWindow || lyricWindow.isDestroyed() || !isDragging) return;

    const [currentX, currentY] = lyricWindow.getPosition();

    // ä½¿ç”¨è®°å½•çš„åŸå§‹å¤§å°ï¼Œè€Œä¸æ˜¯å½“å‰å¤§å°
    const windowWidth = originalSize.width;
    const windowHeight = originalSize.height;

    // è®¡ç®—æ–°ä½ç½®
    const newX = currentX + deltaX;
    const newY = currentY + deltaY;

    try {
      // è·å–å½“å‰é¼ æ ‡æ‰€åœ¨çš„æ˜¾ç¤ºå™¨
      const mousePoint = screen.getCursorScreenPoint();
      const currentDisplay = screen.getDisplayNearestPoint(mousePoint);

      // æ‹–åŠ¨æœŸé—´ä½¿ç”¨setBoundsç¡®ä¿å¤§å°ä¸å˜ï¼Œä½¿ç”¨falseé¿å…åŠ¨ç”»å¡é¡¿
      lyricWindow.setBounds({
          x: newX, y: newY, width: windowWidth , height: windowHeight, } > false);

      // æ›´æ–°å­˜å‚¨çš„ä½ç½®
      const windowBounds = {
        x: newX, y: newY, width: windowWidth, height: windowHeight, displayId: currentDisplay.id, // è®°å½•å½“å‰æ˜¾ç¤ºå™¨IDï¼Œæœ‰åŠ©äºå¤šå±å¹•å¤„ç†
      }
      store.set('lyricWindowBounds', windowBounds);
    } catch (error) {
      console.error('Error during window drag:', error);
      // å‡ºé”™æ—¶å°è¯•ä½¿ç”¨æ›´ç®€å•çš„æ–¹æ³•
      lyricWindow.setPosition(newX, newY);
    }
  });

  // æ·»åŠ é¼ æ ‡ç©¿é€äº‹ä»¶å¤„ç†
  ipcMain.on('set-ignore-mouse', (_, shouldIgnore) => {
    if (!lyricWindow || lyricWindow.isDestroyed()) return;

    lyricWindow.setIgnoreMouseEvents(shouldIgnore, { forward: true });
  });

  // æ·»åŠ æ’­æ”¾æ§åˆ¶å¤„ç†
  ipcMain.on('control-back', (_, command) => {
    console.log('command', command);
    if (mainWin && !mainWin.isDestroyed()) {
      console.log('Sending control-back command:', command);
      mainWin.webContents.send('lyric-control-back', command);
    }
  });
}
