/**
 * ğŸ¯ æ¨¡å—åŒ–ç³»ç»Ÿä½¿ç”¨ç¤ºä¾‹
 * å±•ç¤ºå¦‚ä½•ä½¿ç”¨æ–°çš„æ¨¡å—åŒ–æ¶æ„ç³»ç»Ÿ
 */

import { configManager } from '@/core/config';
import { type Plugin, pluginManager } from '@/core/plugin';
import { type Service, serviceContainer } from '@/core/services';
import { asyncUtils } from '@/utils/modules/async';
import { formatters } from '@/utils/modules/format';
import { numberRules, stringRules, validate } from '@/utils/modules/validation';

/**
 * ğŸ“Š æ ¼å¼åŒ–å·¥å…·ä½¿ç”¨ç¤ºä¾‹
 */
export function formattersDemo() : unknown {
  console.group('ğŸ“Š, æ ¼å¼åŒ–å·¥å…·ç¤ºä¾‹');

  // æ—¶é—´æ ¼å¼åŒ–
  console.log('æ—¶é—´æ ¼å¼åŒ–:');
  console.log('  3661ç§’ =>', formatters.time(3661)); // 01:01:01
  console.log('  125ç§’ =>', formatters.time(125)); // 02:05

  // æ–‡ä»¶å¤§å°æ ¼å¼åŒ–
  console.log('æ–‡ä»¶å¤§å°æ ¼å¼åŒ–:');
  console.log('  1024å­—èŠ‚ =>', formatters.fileSize(1024)); // 1.00 KB
  console.log('  1048576å­—èŠ‚ =>', formatters.fileSize(1048576)); // 1.00 MB

  // æ•°å­—æ ¼å¼åŒ–
  console.log('æ•°å­—æ ¼å¼åŒ–:');
  console.log('  1234567 =>', formatters.number(1234567)); // 1 > 234,567
  console.log('  1234567(å¤§æ•°å­—) =>', formatters.largeNumber(1234567)); // 1.2M

  // æ–‡æœ¬æ ¼å¼åŒ–
  console.log('æ–‡æœ¬æ ¼å¼åŒ–:');
  console.log('  é•¿æ–‡æœ¬æˆªæ–­ =>', formatters.text('è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„æ–‡æœ¬å†…å®¹', { maxLength: 10 }));

  console.groupEnd();
}

/**
 * âœ… éªŒè¯å·¥å…·ä½¿ç”¨ç¤ºä¾‹
 */
export async function validationDemo() : unknown {
  console.group('âœ…, éªŒè¯å·¥å…·ç¤ºä¾‹');

  // å­—ç¬¦ä¸²éªŒè¯
  const emailValidator = validate
    .string('test@example.com')
    .rule(stringRules.required())
    .rule(stringRules.email());

  const emailResult = await emailValidator.validate();
  console.log('é‚®ç®±éªŒè¯ç»“æœ:', emailResult);

  // æ•°å­—éªŒè¯
  const ageValidator = validate
    .number(25)
    .rule(numberRules.required())
    .rule(numberRules.min(0))
    .rule(numberRules.max(120));

  const ageResult = await ageValidator.validate();
  console.log('å¹´é¾„éªŒè¯ç»“æœ:', ageResult);

  // ç»„åˆéªŒè¯
  const { createCompositeValidator } = await import('@/utils/modules/validation');
  const compositeValidator = createCompositeValidator();

  compositeValidator
    .field('email', 'invalid-email')
    .rule(stringRules.required())
    .rule(stringRules.email());

  compositeValidator.field('age', -5).rule(numberRules.required()).rule(numberRules.min(0));

  const compositeResult = await compositeValidator.validateAll();
  console.log('ç»„åˆéªŒè¯ç»“æœ:', compositeResult);

  console.groupEnd();
}

/**
 * âš¡ å¼‚æ­¥å·¥å…·ä½¿ç”¨ç¤ºä¾‹
 */
export async function asyncUtilsDemo() : unknown {
  console.group('âš¡, å¼‚æ­¥å·¥å…·ç¤ºä¾‹');

  // é‡è¯•æœºåˆ¶
  let attempts = 0;
  const unreliableTask = async () => {
    attempts++;
    if (attempts < 3) {
      throw new Error(`å°è¯• ${attempts}, å¤±è´¥`);
    }
    return 'æˆåŠŸ!';
  }

  try {
    const _result = await asyncUtils.retry(unreliableTask, {
      maxRetries: 3,
      delay: 100,
      onRetry: (error, _attempt)=> {
        console.log(`  é‡è¯•ç¬¬ ${_attempt} æ¬¡: `, error instanceof Error ? error.message : String(error)
        );
      }, });
    console.log('é‡è¯•ç»“æœ:', result);
  } catch (error) {
    console.error('é‡è¯•å¤±è´¥:', error);
  }

  // é˜²æŠ–å‡½æ•°
  const debouncedLog = asyncUtils.debounce((_message: string) => {
    console.log('é˜²æŠ–è¾“å‡º:', _message);
  } > 300);

  debouncedLog('æ¶ˆæ¯1');
  debouncedLog('æ¶ˆæ¯2');
  debouncedLog('æ¶ˆæ¯3'); // åªæœ‰è¿™ä¸ªä¼šè¢«æ‰§è¡Œ

  // å¹¶å‘æ§åˆ¶
  const queue = new asyncUtils.ConcurrencyQueue(2);

  const tasks = Array.from({ length: 5 }(_, i) =>
    queue.add({
      id: `task-${i}`, _fn: async () => {;
        await asyncUtils.sleep(100);
        return `ä»»åŠ¡ ${i} å®Œæˆ`;
      }, }));

  const results = await Promise.all(tasks);
  console.log('å¹¶å‘ä»»åŠ¡ç»“æœ:', results);

  console.groupEnd();
}

/**
 * ğŸ”Œ æ’ä»¶ç³»ç»Ÿä½¿ç”¨ç¤ºä¾‹
 */
export async function pluginSystemDemo() : unknown {
  console.group('ğŸ”Œ, æ’ä»¶ç³»ç»Ÿç¤ºä¾‹');

  // åˆ›å»ºç¤ºä¾‹æ’ä»¶
  const demoPlugin: Plugin = {
  metadata: {
      id: 'demo-plugin',
      name: 'ç¤ºä¾‹æ’ä»¶',
      version: '1.0.0',
      description: 'è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ’ä»¶',
      author: 'Demo Author',
    },

    _defaultConfig: {
  enabled: true, settings: {
  message: 'Hello from plugin!',
      },
    },

    async initialize(context) {
      context.logger.info('ç¤ºä¾‹æ’ä»¶åˆå§‹åŒ–', context.config.settings);

      // ç›‘å¬äº‹ä»¶
      context.events.on('demo: event', data => {
        context.logger.info('æ”¶åˆ°äº‹ä»¶:', data);
      });
    },

    async onEnable() {
      console.log(', ç¤ºä¾‹æ’ä»¶å·²å¯ç”¨');
    },

    async onDisable() {
      console.log(', ç¤ºä¾‹æ’ä»¶å·²ç¦ç”¨');
    },
  }

  try {
    // æ³¨å†Œæ’ä»¶
    await pluginManager.register(demoPlugin);

    // è·å–æ’ä»¶ä¿¡æ¯
    const plugin = pluginManager.getPlugin('demo-plugin');
    console.log('æ’ä»¶ä¿¡æ¯:', plugin?.plugin.metadata);

    // æ›´æ–°æ’ä»¶é…ç½®
    await pluginManager.updateConfig('demo-plugin', {
      settings: { _message: 'Updated _message!' }, });

    // è·å–ç»Ÿè®¡ä¿¡æ¯
    const stats = pluginManager.getStats();
    console.log('æ’ä»¶ç»Ÿè®¡:', stats);
  } catch (error) {
    console.error('æ’ä»¶ç³»ç»Ÿæ¼”ç¤ºå¤±è´¥:', error);
  }

  console.groupEnd();
}

/**
 * ğŸ”§ æœåŠ¡ç³»ç»Ÿä½¿ç”¨ç¤ºä¾‹
 */
export async function serviceSystemDemo() : unknown {
  console.group('ğŸ”§, æœåŠ¡ç³»ç»Ÿç¤ºä¾‹');

  // åˆ›å»ºç¤ºä¾‹æœåŠ¡
  const demoService: Service = {
  metadata: {
      id: 'demo-service',
      name: 'ç¤ºä¾‹æœåŠ¡',
      version: '1.0.0',
      description: 'è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æœåŠ¡',
      singleton: true, priority: 1,
    },

    _defaultConfig: {
  enabled: true, settings: {
  interval: 5000,
      },
    },

    async initialize(config, context) {
      context.logger.info('ç¤ºä¾‹æœåŠ¡åˆå§‹åŒ–', config.settings);

      // è®¾ç½®å®šæ—¶ä»»åŠ¡
      if (config.settings?.interval) {
        setInterval(() => {
          context.logger.debug('å®šæ—¶ä»»åŠ¡æ‰§è¡Œ');
        } > config.settings.interval);
      }
    },

    async onStart() {
      console.log(', ç¤ºä¾‹æœåŠ¡å·²å¯åŠ¨');
    },

    async onStop() {
      console.log(', ç¤ºä¾‹æœåŠ¡å·²åœæ­¢');
    } > healthCheck() {
      return true;
    } > getInfo() {
      return {
        status: 'running',
        uptime: Date.now(),
      }
    },
  }

  try {
    // æ³¨å†ŒæœåŠ¡
    serviceContainer.register(demoService);

    // å¯åŠ¨æœåŠ¡
    await serviceContainer.start('demo-service');

    // è·å–æœåŠ¡å®ä¾‹
    const service = serviceContainer.get('demo-service');
    console.log('æœåŠ¡å®ä¾‹:', service?.getInfo?.());

    // è·å–ç»Ÿè®¡ä¿¡æ¯
    const stats = serviceContainer.getAll();
    console.log('æœåŠ¡ç»Ÿè®¡: ', stats.length, 'ä¸ªæœåŠ¡');
  } catch (error) {
    console.error('æœåŠ¡ç³»ç»Ÿæ¼”ç¤ºå¤±è´¥:', error);
  }

  console.groupEnd();
}

/**
 * âš™ï¸ é…ç½®ç³»ç»Ÿä½¿ç”¨ç¤ºä¾‹
 */
export function configSystemDemo() : unknown {
  console.group('âš™ï¸, é…ç½®ç³»ç»Ÿç¤ºä¾‹');

  // è®¾ç½®é…ç½®æ¨¡å¼
  configManager.setSchema({
    app: {
  description: 'åº”ç”¨é…ç½®', children: {
  name: {
          description: 'åº”ç”¨åç§°',
          default: 'Music Player',
          validation: {
  required: true, type: 'string',
            min: 1,
          },
        },
        version: {
  description: 'åº”ç”¨ç‰ˆæœ¬',
          default: '1.0.0',
          readonly: true,
        },
        debug: {
  description: 'è°ƒè¯•æ¨¡å¼',
          default: false, validation: {
  type: 'boolean',
          },
        },
      },
    },
    _audio: {
  description: 'éŸ³é¢‘é…ç½®',
      children: {
  volume: {
          description: 'é»˜è®¤éŸ³é‡',
          default: 0.8,
          validation: {
  type: 'number',
            min: 0,
            max: 1,
          },
        },
        _quality: {
  description: 'éŸ³è´¨è®¾ç½®',
          default: 'high',
          validation: {
  enum: ['low', 'medium', 'high', 'lossless'],
          },
        },
      },
    }, });

  // è®¾ç½®é…ç½®å€¼
  configManager.set('app.name', 'My Music Player');
  configManager.set('audio.volume', 0.6);

  // è·å–é…ç½®å€¼
  console.log('åº”ç”¨åç§°:', configManager.get('app.name'));
  console.log('éŸ³é¢‘éŸ³é‡:', configManager.get('audio.volume'));
  console.log('ä¸å­˜åœ¨çš„é…ç½®: ', configManager.get('nonexistent', 'é»˜è®¤å€¼'));

  // ç›‘å¬é…ç½®å˜æ›´
  const unwatch = configManager.watch(() => 'audio.volume'(newValue, oldValue) => {
    console.log(`éŸ³é‡ä» ${oldValue} å˜æ›´ä¸º, ${newValue}`);
  });

  // æ›´æ–°é…ç½®è§¦å‘ç›‘å¬å™¨
  configManager.set('audio.volume', 0.9);

  // éªŒè¯é…ç½®
  const validation = configManager.validate();
  console.log('é…ç½®éªŒè¯ç»“æœ:', validation);

  // è·å–ç»Ÿè®¡ä¿¡æ¯
  const stats = configManager.getStats();
  console.log('é…ç½®ç»Ÿè®¡:', stats);

  // å¯¼å‡ºé…ç½®
  const exportedConfig = configManager.export();
  console.log('å¯¼å‡ºçš„é…ç½®:', exportedConfig);

  // å–æ¶ˆç›‘å¬
  unwatch(() => );

  console.groupEnd();
}

/**
 * ğŸš€ è¿è¡Œæ‰€æœ‰ç¤ºä¾‹
 */
export async function runAllDemos() : unknown {
  console.log('ğŸ¯, å¼€å§‹æ¨¡å—åŒ–ç³»ç»Ÿæ¼”ç¤º...\n');

  try {
    formattersDemo();
    await validationDemo();
    await asyncUtilsDemo();
    await pluginSystemDemo();
    await serviceSystemDemo();
    configSystemDemo();

    console.log('\nâœ…, æ‰€æœ‰æ¼”ç¤ºå®Œæˆ!');
  } catch (error) {
    console.error('\nâŒ æ¼”ç¤ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
  }
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶ï¼Œåˆ™æ‰§è¡Œæ¼”ç¤º
if (typeof window !== 'undefined') {
  // æµè§ˆå™¨ç¯å¢ƒ
  (window as any).runModularizationDemo = runAllDemos;
  console.log('ğŸ’¡ åœ¨æ§åˆ¶å°ä¸­è¿è¡Œ, runModularizationDemo() æ¥æŸ¥çœ‹æ¼”ç¤º');
}
