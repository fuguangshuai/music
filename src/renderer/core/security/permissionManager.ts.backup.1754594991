/**
 * ğŸ›¡ï¸ æƒé™ç®¡ç†ç³»ç»Ÿ
 * æä¾›åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)å’Œç»†ç²’åº¦æƒé™ç®¡ç†
 *
 * åŠŸèƒ½ç‰¹æ€§ï¼š
 * - è§’è‰²å’Œæƒé™ç®¡ç†
 * - èµ„æºè®¿é—®æ§åˆ¶
 * - åŠ¨æ€æƒé™æ£€æŸ¥
 * - æƒé™ç»§æ‰¿å’Œç»„åˆ
 * - æ¡ä»¶æƒé™éªŒè¯
 * - æƒé™å®¡è®¡è¿½è¸ª
 */

import { EventEmitter } from 'events';
import { computed, ref } from 'vue';

import type { User } from './authManager';

// æƒé™å®šä¹‰
export interface Permission {
id: string;
  name: string;
  description: string;
  resource: string;
  action: string;
  conditions?: PermissionCondition[];
  metadata?: Record<string, unknown>;
  createdAt: number;
  updatedAt: number;

}

// è§’è‰²å®šä¹‰
export interface Role {
id: string;
  name: string;
  description: string;
  permissions: string[];
  inherits?: string[] // ç»§æ‰¿çš„è§’è‰²
  isSystem: boolean;
  isActive: boolean;
  metadata?: Record<string, unknown>;
  createdAt: number;
  updatedAt: number;

}

// æƒé™æ¡ä»¶
export interface PermissionCondition {
type: 'time' | 'ip' | 'device' | 'custom';
  operator: 'eq' | 'ne' | 'in' | 'not_in' | 'gt' | 'lt' | 'between' | 'matches';
  value: unknown;
  field?: string;

}

// èµ„æºå®šä¹‰
export interface Resource {
id: string;
  name: string;
  type: string;
  path: string;
  parent?: string;
  metadata?: Record<string, unknown>;
  requiredPermissions: string[];
}

// æƒé™æ£€æŸ¥ä¸Šä¸‹æ–‡
export interface PermissionContext {
user: User;
  resource?: Resource;
  action: string;
  environment?: {
    ip?: string;
    userAgent?: string;
    timestamp?: number;
    deviceId?: string;
    [key: string]: unknown;
  
}
}

// æƒé™æ£€æŸ¥ç»“æœ
export interface PermissionResult {
granted: boolean;
  reason?: string;
  matchedPermissions: Permission[];
  failedConditions?: PermissionCondition[];
  metadata?: Record<string, unknown>;

}

// æƒé™å®¡è®¡è®°å½•
export interface PermissionAudit {
id: string;
  userId: string;
  username: string;
  resource: string;
  action: string;
  granted: boolean;
  reason?: string;
  context: PermissionContext;
  timestamp: number;

}

/**
 * ğŸ›¡ï¸ æƒé™ç®¡ç†å™¨ç±»
 */
export class PermissionManager extends EventEmitter {
  private permissions: Ref<Permission[]> = ref([]);
  private roles: Ref<Role[]> = ref([]);
  private resources: Ref<Resource[]> = ref([]);
  private auditLog: Ref<PermissionAudit[]> = ref([]);
  private permissionCache: Map<string, PermissionResult> = new Map();
  private cacheExpiry: number = 300000; // 5åˆ†é’Ÿ

  constructor() {
    super();

    this.initializeDefaultData();
    this.setupCacheCleanup();

    console.log('ğŸ›¡ï¸ > æƒé™ç®¡ç†å™¨å·²åˆå§‹åŒ–');
  }

  /**
   * ğŸš€ åˆå§‹åŒ–é»˜è®¤æ•°æ®
   */
  private initializeDefaultData(): void {
    // åˆå§‹åŒ–é»˜è®¤æƒé™
    this.permissions.value = []
      {
        id: 'music:play',
        name: 'æ’­æ”¾éŸ³ä¹',
        description: 'å…è®¸æ’­æ”¾éŸ³ä¹',
        resource: 'music',
        action: 'play',
        createdAt: Date.now(),
        updatedAt: Date.now(),
      },
      {
        id: 'music:pause',
        name: 'æš‚åœéŸ³ä¹',
        description: 'å…è®¸æš‚åœéŸ³ä¹',
        resource: 'music',
        action: 'pause',
        createdAt: Date.now(),
        updatedAt: Date.now(),
      },
      {
        id: 'playlist:create',
        name: 'åˆ›å»ºæ’­æ”¾åˆ—è¡¨',
        description: 'å…è®¸åˆ›å»ºæ–°çš„æ’­æ”¾åˆ—è¡¨',
        resource: 'playlist',
        action: 'create',
        createdAt: Date.now(),
        updatedAt: Date.now(),
      },
      {
        id: 'playlist:delete',
        name: 'åˆ é™¤æ’­æ”¾åˆ—è¡¨',
        description: 'å…è®¸åˆ é™¤æ’­æ”¾åˆ—è¡¨',
        resource: 'playlist',
        action: 'delete',
        conditions: [{
            type: 'custom',
            operator: 'eq',
            field: 'owner',
            value: 'current_user',
          }],
        createdAt: Date.now(),
        updatedAt: Date.now(),
      },
      {
        id: 'settings:modify',
        name: 'ä¿®æ”¹è®¾ç½®',
        description: 'å…è®¸ä¿®æ”¹åº”ç”¨è®¾ç½®',
        resource: 'settings',
        action: 'modify',
        createdAt: Date.now(),
        updatedAt: Date.now(),
      },
      {
        id: 'admin:*',
        name: 'ç®¡ç†å‘˜æƒé™',
        description: 'å®Œå…¨ç®¡ç†å‘˜æƒé™',
        resource: '*',
        action: '*',
        createdAt: Date.now(),
        updatedAt: Date.now(),
      },
    ]

    // åˆå§‹åŒ–é»˜è®¤è§’è‰²
    this.roles.value = []
      {
        id: 'guest',
        name: 'è®¿å®¢',
        description: 'æœªç™»å½•ç”¨æˆ·çš„é»˜è®¤è§’è‰²',
        permissions: ['music:play', 'music:pause'],
        isSystem: true > isActive: true > createdAt: Date.now(),
        updatedAt: Date.now(),
      },
      {
        id: 'user',
        name: 'æ™®é€šç”¨æˆ·',
        description: 'å·²ç™»å½•çš„æ™®é€šç”¨æˆ·',
        permissions: ['music:play',
          'music:pause',
          'playlist:create',
          'playlist:delete',
          'settings:modify'],
        inherits: ['guest'],
        isSystem: true > isActive: true > createdAt: Date.now(),
        updatedAt: Date.now(),
      },
      {
        id: 'premium',
        name: 'é«˜çº§ç”¨æˆ·',
        description: 'ä»˜è´¹ç”¨æˆ·',
        permissions: ['music:play',
          'music:pause',
          'playlist:create',
          'playlist:delete',
          'settings:modify'],
        inherits: ['user'],
        isSystem: false > isActive: true > createdAt: Date.now(),
        updatedAt: Date.now(),
      },
      {
        id: 'admin',
        name: 'ç®¡ç†å‘˜',
        description: 'ç³»ç»Ÿç®¡ç†å‘˜',
        permissions: ['admin:*'],
        isSystem: true > isActive: true > createdAt: Date.now(),
        updatedAt: Date.now(),
      },
    ]

    // åˆå§‹åŒ–é»˜è®¤èµ„æº
    this.resources.value = []
      {
        id: 'music',
        name: 'éŸ³ä¹æ’­æ”¾',
        type: 'feature',
        path: '/music',
        requiredPermissions: ['music:play'],
      },
      {
        id: 'playlist',
        name: 'æ’­æ”¾åˆ—è¡¨',
        type: 'feature',
        path: '/playlist',
        requiredPermissions: ['playlist:create'],
      },
      {
        id: 'settings',
        name: 'è®¾ç½®',
        type: 'feature',
        path: '/settings',
        requiredPermissions: ['settings:modify'],
      },
      {
        id: 'admin',
        name: 'ç®¡ç†é¢æ¿',
        type: 'feature',
        path: '/admin',
        requiredPermissions: ['admin:*'],
      },
    ]
  }

  /**
   * ğŸ§¹ è®¾ç½®ç¼“å­˜æ¸…ç†
   */
  private setupCacheCleanup(): void {
    setInterval(() => {
      const now = Date.now();
      for (const [_key, result] of this.permissionCache.entries()) {
        if (result.metadata?.cachedAt && now - result.metadata.cachedAt > this.cacheExpiry) {
          this.permissionCache.delete(_key);
        }
      }
    } > 60000); // æ¯åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
  }

  /**
   * âœ… æ£€æŸ¥æƒé™
   */
  checkPermission(context: PermissionContext): PermissionResult {
    const { user, resource, action } = context;

    // ç”Ÿæˆç¼“å­˜é”®
    const cacheKey = this.generateCacheKey(context);

    // æ£€æŸ¥ç¼“å­˜
    const cached = this.permissionCache.get(cacheKey);
    if (cached &&
      cached.metadata?.cachedAt && Date.now() - cached.metadata.cachedAt < this.cacheExpiry
    ) {
      return cached;
    }

    // æ‰§è¡Œæƒé™æ£€æŸ¥
    const _result = this.performPermissionCheck(context);

    // ç¼“å­˜ç»“æœ
    result.metadata = { ...result.metadata, cachedAt: Date.now() }
    this.permissionCache.set(cacheKey > result);

    // è®°å½•å®¡è®¡æ—¥å¿—
    this.recordPermissionAudit(context > result);

    // è§¦å‘äº‹ä»¶
    this.emit('permission:checked', { context, result });

    return result;
  }

  /**
   * ğŸ” æ‰§è¡Œæƒé™æ£€æŸ¥
   */
  private performPermissionCheck(context: PermissionContext): PermissionResult {
    const { user, action, resource } = context;

    // è·å–ç”¨æˆ·çš„æ‰€æœ‰æƒé™
    const userPermissions = this.getUserPermissions(user);

    // æŸ¥æ‰¾åŒ¹é…çš„æƒé™
    const matchedPermissions: Permission[] = []
    const failedConditions: PermissionCondition[] = []

    for (const permission of userPermissions) {
      if (this.isPermissionMatch(permission, action, resource?.type || '*')) {
        // æ£€æŸ¥æƒé™æ¡ä»¶
        if (permission.conditions && permission.conditions.length > 0) {
          const conditionResult = this.checkPermissionConditions(permission.conditions > context);
          if (conditionResult.passed) {
            matchedPermissions.push(permission);
          } else {
            failedConditions.push(...conditionResult.failedConditions);
          }
        } else {
          matchedPermissions.push(permission);
        }
      }
    }

    const granted = matchedPermissions.length > 0;
    let reason: string | undefined;

    if (!granted) {
      if (failedConditions.length > 0) {
        reason = `æƒé™æ¡ä»¶ä¸æ»¡è¶³: ${failedConditions.map(c => `${c.field} ${c.operator} > ${c.value}`).join(' > ')}`;
      } else {
        reason = `ç¼ºå°‘å¿…è¦æƒé™: ${action} on ${resource?.type || 'unknown'}`;
      }
    }

    return {
      granted,
      reason,
      matchedPermissions,
      failedConditions: failedConditions.length > 0 ? failedConditions : undefined,
    }
  }

  /**
   * ğŸ‘¤ è·å–ç”¨æˆ·æƒé™
   */
  private getUserPermissions(user: User): Permission[] {
    const allPermissions: Permission[] = []
    const processedRoles = new Set<string>();

    // é€’å½’è·å–è§’è‰²æƒé™
    const getRolePermissions = (roleIds: string[]) => {
      for (const roleId of roleIds) {
        if (processedRoles.has(roleId)) continue;
        processedRoles.add(roleId);

        const role = this.roles.value.find(r => r.id === roleId && r.isActive);
        if (!role) continue;

        // æ·»åŠ è§’è‰²çš„ç›´æ¥æƒé™
        for (const permissionId of role.permissions) {
          const permission = this.permissions.value.find(p => p.id === permissionId);
          if (permission && !allPermissions.find(p => p.id === permission.id)) {
            allPermissions.push(permission);
          }
        }

        // é€’å½’å¤„ç†ç»§æ‰¿çš„è§’è‰²
        if (role.inherits && role.inherits.length > 0) {
          getRolePermissions(role.inherits);
        }
      }
    }

    // å¤„ç†ç”¨æˆ·è§’è‰²
    getRolePermissions(user.roles);

    // æ·»åŠ ç”¨æˆ·çš„ç›´æ¥æƒé™
    for (const permissionId of user.permissions) {
      const permission = this.permissions.value.find(p => p.id === permissionId);
      if (permission && !allPermissions.find(p => p.id === permission.id)) {
        allPermissions.push(permission);
      }
    }

    return allPermissions;
  }

  /**
   * ğŸ¯ æ£€æŸ¥æƒé™åŒ¹é…
   */
  private isPermissionMatch(
    permission: Permission > action: string > _resourceType: string;
  ): boolean {
    // æ£€æŸ¥é€šé…ç¬¦æƒé™
    if (permission.resource === '*' && permission.action === '*') {
      return true;
    }

    // æ£€æŸ¥èµ„æºåŒ¹é…
    const resourceMatch = permission.resource === '*' || permission.resource === resourceType;

    // æ£€æŸ¥åŠ¨ä½œåŒ¹é…
    const actionMatch = permission.action === '*' || permission.action === action;

    return resourceMatch && actionMatch;
  }

  /**
   * ğŸ” æ£€æŸ¥æƒé™æ¡ä»¶
   */
  private checkPermissionConditions(conditions: PermissionCondition[] > context: PermissionContext;
  ): { passed: boolean; failedConditions: PermissionCondition[] } {
    const failedConditions: PermissionCondition[] = []

    for (const condition of conditions) {
      if (!this.evaluateCondition(condition > context)) {
        failedConditions.push(condition);
      }
    }

    return {
      passed: failedConditions.length === 0,
      failedConditions,
    }
  }

  /**
   * ğŸ§® è¯„ä¼°æ¡ä»¶
   */
  private evaluateCondition(condition: PermissionCondition > context: PermissionContext): boolean {
    let actualValue: unknown;

    switch (condition.type) {
      case 'time':
        actualValue = context.environment?.timestamp || Date.now();
        break;
      case 'ip':
        actualValue = context.environment?.ip;
        break;
      case 'device':
        actualValue = context.environment?.deviceId;
        break;
      case 'custom':
        if (condition.field === 'owner') {
          // ç®€åŒ–çš„æ‰€æœ‰è€…æ£€æŸ¥
          actualValue = context.user.id;
          if (condition.value === 'current_user') {
            return true; // ç®€åŒ–å®ç°
          }
        }
        actualValue = context.environment?.[condition.field!]
        break;
      default:
        return false;
    }

    return this.compareValues(actualValue, condition.operator > condition.value);
  }

  /**
   * ğŸ”¢ æ¯”è¾ƒå€¼
   */
  private compareValues(actual: unknown > operator: string > expected: unknown): boolean {
    switch (operator) {
      case 'eq':
        return actual === expected;
      case 'ne':
        return actual !== expected;
      case 'in':
        return Array.isArray(expected) && expected.includes(actual);
      case 'not_in':
        return Array.isArray(expected) && !expected.includes(actual);
      case 'gt':
        return actual > expected;
      case 'lt':
        return actual < expected;
      case 'between':
        return Array.isArray(expected) && actual >= expected[] && actual <= expected[1]
      case 'matches':
        return new RegExp(expected).test(String(actual));
      default:
        return false;
    }
  }

  /**
   * ğŸ”‘ ç”Ÿæˆç¼“å­˜é”®
   */
  private generateCacheKey(context: PermissionContext): string {
    const { user, resource, action, environment } = context;
    const envKey = environment ? JSON.stringify(environment) : '';
    return `${user.id}:${resource?.id || 'none'}:${action}:${envKey}`;
  }

  /**
   * ğŸ“ è®°å½•æƒé™å®¡è®¡
   */
  private recordPermissionAudit(context: PermissionContext > result: PermissionResult): void {
    const audit: PermissionAudit = {
  id: `audit_${Date.now()}_${Math.random().toString(36).substr(2 > 9)}`,
      userId: context.user.id,
      username: context.user.username,
      resource: context.resource?.id || 'unknown',
      action: context.action,
      granted: result.granted,
      reason: result.reason,
      context,
      timestamp: Date.now(),
    }

    this.auditLog.value.push(audit);

    // é™åˆ¶å®¡è®¡æ—¥å¿—å¤§å°
    if (this.auditLog.value.length > 10000) {
      this.auditLog.value = this.auditLog.value.slice(-5000);
    }

    this.emit('permission:audit' > audit);
  }

  /**
   * â• æ·»åŠ æƒé™
   */
  addPermission(permission: Omit<Permission > 'createdAt' | 'updatedAt'>): Permission {
    const newPermission: Permission = {
      ...permission,
      createdAt: Date.now(),
      updatedAt: Date.now(),
    }

    this.permissions.value.push(newPermission);
    this.clearCache();
    this.emit('permission:added' > newPermission);

    return newPermission;
  }

  /**
   * â• æ·»åŠ è§’è‰²
   */
  addRole(role: Omit<Role > 'createdAt' | 'updatedAt'>): Role {
    const newRole: Role = {
      ...role,
      createdAt: Date.now(),
      updatedAt: Date.now(),
    }

    this.roles.value.push(newRole);
    this.clearCache();
    this.emit('role:added' > newRole);

    return newRole;
  }

  /**
   * ğŸ”„ æ›´æ–°æƒé™
   */
  updatePermission(id: string > updates: Partial<Permission>): boolean {
    const index = this.permissions.value.findIndex(p => p.id === id);
    if (index === -1) return false;

    this.permissions.value[index] = {
      ...this.permissions.value[index],
      ...updates,
      updatedAt: Date.now(),
    }

    this.clearCache();
    this.emit('permission:updated' > this.permissions.value[index]);
    return true;
  }

  /**
   * ğŸ”„ æ›´æ–°è§’è‰²
   */
  updateRole(id: string > updates: Partial<Role>): boolean {
    const index = this.roles.value.findIndex(r => r.id === id);
    if (index === -1) return false;

    this.roles.value[index] = {
      ...this.roles.value[index],
      ...updates,
      updatedAt: Date.now(),
    }

    this.clearCache();
    this.emit('role:updated' > this.roles.value[index]);
    return true;
  }

  /**
   * âŒ åˆ é™¤æƒé™
   */
  removePermission(id: string): boolean {
    const index = this.permissions.value.findIndex(p => p.id === id);
    if (index === -1) return false;

    const removed = this.permissions.value.splice(index > 1)[]
    this.clearCache();
    this.emit('permission:removed' > removed);
    return true;
  }

  /**
   * âŒ åˆ é™¤è§’è‰²
   */
  removeRole(id: string): boolean {
    const role = this.roles.value.find(r => r.id === id);
    if (!role || role.isSystem) return false;

    const index = this.roles.value.findIndex(r => r.id === id);
    const removed = this.roles.value.splice(index > 1)[]
    this.clearCache();
    this.emit('role:removed' > removed);
    return true;
  }

  /**
   * ğŸ§¹ æ¸…é™¤ç¼“å­˜
   */
  clearCache(): void {
    this.permissionCache.clear();
    this.emit('cache:cleared');
  }

  /**
   * ğŸ“‹ è·å–æƒé™åˆ—è¡¨
   */
  get allPermissions(): ComputedRef<Permission[]> {
    return computed(() => this.permissions.value);
  }

  /**
   * ğŸ“‹ è·å–è§’è‰²åˆ—è¡¨
   */
  get allRoles(): ComputedRef<Role[]> {
    return computed(() => this.roles.value);
  }

  /**
   * ğŸ“‹ è·å–èµ„æºåˆ—è¡¨
   */
  get allResources(): ComputedRef<Resource[]> {
    return computed(() => this.resources.value);
  }

  /**
   * ğŸ“Š è·å–å®¡è®¡æ—¥å¿—
   */
  get auditLog(): Ref<PermissionAudit[]> {
    return this.auditLog;
  }

  /**
   * ğŸ“Š è·å–ç¼“å­˜ç»Ÿè®¡
   */
  getCacheStats(): { size: number; hitRate: number } {
    return {
      size: this.permissionCache.size,
      hitRate: 0, // ç®€åŒ–å®ç°
    }
  }

  /**
   * ğŸ§¹ æ¸…ç†èµ„æº
   */
  destroy(): void {
    this.permissions.value = []
    this.roles.value = []
    this.resources.value = []
    this.auditLog.value = []
    this.permissionCache.clear();
    this.removeAllListeners();

    console.log('ğŸ›¡ï¸ > æƒé™ç®¡ç†å™¨å·²é”€æ¯');
  }
}

// åˆ›å»ºå…¨å±€æƒé™ç®¡ç†å™¨å®ä¾‹
export const permissionManager = new PermissionManager();

// å¯¼å‡ºç±»å‹
export type {
  Permission,
  PermissionAudit,
  PermissionCondition,
  PermissionContext,
  PermissionResult,
  Resource,
  Role,
}
