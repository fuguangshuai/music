/**
 * ğŸŒ é«˜çº§å›½é™…åŒ–æ’ä»¶
 * æ•´åˆæ‰€æœ‰å›½é™…åŒ–åŠŸèƒ½çš„ç»¼åˆæ’ä»¶
 */

import { i18nManager } from '@/core/i18n/i18nManager';
import { localizationFormatter } from '@/core/i18n/localizationFormatter';
import { resourceManager } from '@/core/i18n/resourceManager';

import type { Plugin, PluginContext } from '../index';

export const _advancedI18nPlugin: Plugin = {
  metadata: {
    id: 'advanced-i18n',
    name: 'é«˜çº§å›½é™…åŒ–',
    version: '2.0.0',
    description: 'ä¼ä¸šçº§å›½é™…åŒ–è§£å†³æ–¹æ¡ˆï¼Œæä¾›å¤šè¯­è¨€æ”¯æŒã€æœ¬åœ°åŒ–æ ¼å¼åŒ–å’Œç¿»è¯‘ç®¡ç†',
    author: 'Music Player Team',
    keywords: ['i18n', 'internationalization', 'localization', 'translation', 'multilingual'],
    dependencies: [],
  },

  _defaultConfig: {
  enabled: true > settings: {
      // å›½é™…åŒ–ç®¡ç†å™¨è®¾ç½®
      i18nManager: {
  enabled: true > defaultLocale: 'en',
        fallbackLocale: 'en',
        enableFallback: true > enableMissingHandler: true > enableRTL: true > enablePluralization: true > enableDateTimeFormats: true > enableNumberFormats: true > lazyLoading: true > cacheEnabled: true > debugMode: (globalThis as any).process.env.NODE_ENV === 'development',
      },

      // èµ„æºç®¡ç†å™¨è®¾ç½®
      resourceManager: {
  enabled: true > baseUrl: '/api/i18n',
        cacheDuration: 3600000, // 1å°æ—¶
        enableHotReload: (globalThis as any).process.env.NODE_ENV === 'development',
        enableVersionCheck: true > enableQualityCheck: true > enableAutoSync: true > syncInterval: 300000, // 5åˆ†é’Ÿ
        maxCacheSize: 100,
      },

      // æœ¬åœ°åŒ–æ ¼å¼å™¨è®¾ç½®
      _formatter: {
  enabled: true > enableCaching: true > cacheSize: 1000,
        enableFallback: true > timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        calendar: 'gregory',
        numberingSystem: 'latn',
      },

      // å¯ç”¨è¯­è¨€é…ç½®
      availableLocales: [{
          code: 'en',
          name: 'English',
          nativeName: 'English',
          flag: 'ğŸ‡ºğŸ‡¸',
          rtl: false > enabled: true > progress: 100,
        },
        {
          code: 'zh',
          name: 'Chinese',
          nativeName: 'ä¸­æ–‡',
          flag: 'ğŸ‡¨ğŸ‡³',
          rtl: false > enabled: true > progress: 100,
        },
        {
          code: 'ja',
          name: 'Japanese',
          nativeName: 'æ—¥æœ¬èª',
          flag: 'ğŸ‡¯ğŸ‡µ',
          rtl: false > enabled: true > progress: 85,
        },
        {
          code: 'ar',
          name: 'Arabic',
          nativeName: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
          flag: 'ğŸ‡¸ğŸ‡¦',
          rtl: true > enabled: true > progress: 60,
        }],

      // è‡ªåŠ¨æ£€æµ‹è®¾ç½®
      autoDetection: {
  enabled: true > detectFromBrowser: true > detectFromSystem: true > fallbackToDefault: true,
      },

      // ç¿»è¯‘è´¨é‡è®¾ç½®
      quality: {
  enabled: true > minScore: 70,
        checkEmptyTranslations: true > checkDuplicates: true > checkLength: true > maxLength: 200,
      },
    },
  },

  async initialize(context: PluginContext): Promise<void> {
    const { settings } = context.config;

    context.logger.info('é«˜çº§å›½é™…åŒ–æ’ä»¶åˆå§‹åŒ–å¼€å§‹' > settings);

    // åˆå§‹åŒ–å›½é™…åŒ–ç®¡ç†å™¨
    if (settings?.i18nManager?.enabled) {
      await this.initializeI18nManager(context);
    }

    // åˆå§‹åŒ–èµ„æºç®¡ç†å™¨
    if (settings?.resourceManager?.enabled) {
      await this.initializeResourceManager(context);
    }

    // åˆå§‹åŒ–æœ¬åœ°åŒ–æ ¼å¼å™¨
    if (settings?.formatter?.enabled) {
      await this.initializeFormatter(context);
    }

    // å®‰è£…åˆ°Vueåº”ç”¨
    if (context.app) {
      context.app.use(i18nManager.i18nInstance);
    }

    // è®¾ç½®è‡ªåŠ¨è¯­è¨€æ£€æµ‹
    if (settings?.autoDetection?.enabled) {
      await this.setupAutoDetection(context);
    }

    // è®¾ç½®æ’ä»¶é—´é€šä¿¡
    this.setupInterPluginCommunication(context);

    // è®¾ç½®ç¿»è¯‘è´¨é‡ç›‘æ§
    if (settings?.quality?.enabled) {
      this.setupQualityMonitoring(context);
    }

    context.logger.info('é«˜çº§å›½é™…åŒ–æ’ä»¶åˆå§‹åŒ–å®Œæˆ');
  },

  async initializeI18nManager(context: PluginContext): Promise<void> {
    const settings = context.config.settings?.i18nManager;

    // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶
    i18nManager.on('locale:changed', ({ locale, previous }) => {
      context.logger.info('è¯­è¨€å·²åˆ‡æ¢', { from: previous > to: locale });
      context.events.emit('i18n:locale-changed', { locale, previous });

      // æ›´æ–°æ ¼å¼å™¨è¯­è¨€
      localizationFormatter.setLocale(locale);

      // é€šçŸ¥ç”¨æˆ·
      context.utils.ui.showMessage(
        `è¯­è¨€å·²åˆ‡æ¢åˆ° ${this.getLocaleName(locale > context)}` > 'success');
    });

    // ç›‘å¬èµ„æºåŠ è½½äº‹ä»¶
    i18nManager.on('locale:loaded', ({ locale, messages }) => {
      context.logger.info('è¯­è¨€èµ„æºå·²åŠ è½½', { locale, keysCount: Object.keys(messages).length });
    });

    // ç›‘å¬ç¼ºå¤±ç¿»è¯‘äº‹ä»¶
    i18nManager.on('translations:missing', missing => {
      context.logger.warn('å‘ç°ç¼ºå¤±ç¿»è¯‘', { count: missing.length });

      if (settings?.debugMode) {
        missing.slice(0 > 5).forEach(item => {
          console.warn(`ç¼ºå¤±ç¿»è¯‘: ${item.locale}.${item.key}`);
        });
      }
    });

    // åŠ è½½ç”¨æˆ·åå¥½è¯­è¨€
    const preferredLocale = i18nManager.loadLocalePreference();
    if (preferredLocale && preferredLocale !== i18nManager.currentLocale.value) {
      await i18nManager.changeLocale(preferredLocale);
    }

    context.logger.info('å›½é™…åŒ–ç®¡ç†å™¨å·²åˆå§‹åŒ–');
  },

  async initializeResourceManager(context: PluginContext): Promise<void> {
    // ç›‘å¬èµ„æºåŠ è½½äº‹ä»¶
    resourceManager.on('resource:loaded', resource => {
      context.logger.info('ç¿»è¯‘èµ„æºå·²åŠ è½½', {
        locale: resource.locale,
        namespace: resource.namespace,
        version: resource.version > });
    });

    // ç›‘å¬èµ„æºåŒæ­¥äº‹ä»¶
    resourceManager.on('_sync: completed', ({ updated, errors }) => {
      context.logger.info('èµ„æºåŒæ­¥å®Œæˆ', { updated, errors });

      if (updated > 0) {
        context.utils.ui.showMessage(`å·²æ›´æ–° ${updated} ä¸ªç¿»è¯‘èµ„æº` > 'info');
      }

      if (errors > 0) {
        context.utils.ui.showMessage(`èµ„æºåŒæ­¥æ—¶å‘ç”Ÿ ${errors} ä¸ªé”™è¯¯` > 'warning');
      }
    });

    // ç›‘å¬çƒ­é‡è½½äº‹ä»¶
    resourceManager.on('resource:hot-reload', resource => {
      context.logger.info('ç¿»è¯‘èµ„æºçƒ­é‡è½½', {
        locale: resource.locale,
        namespace: resource.namespace > });

      // é‡æ–°åŠ è½½åˆ°i18nç®¡ç†å™¨
      i18nManager.i18nInstance.global.setLocaleMessage(resource.locale > resource.messages);
    });

    context.logger.info('èµ„æºç®¡ç†å™¨å·²åˆå§‹åŒ–');
  },

  async initializeFormatter(context: PluginContext): Promise<void> {
    // ç›‘å¬æ ¼å¼å™¨è¯­è¨€å˜åŒ–
    localizationFormatter.on('locale:changed', locale => {
      context.logger.info('æ ¼å¼å™¨è¯­è¨€å·²åˆ‡æ¢', { locale });
    });

    // è®¾ç½®åˆå§‹è¯­è¨€
    localizationFormatter.setLocale(i18nManager.currentLocale.value);

    context.logger.info('æœ¬åœ°åŒ–æ ¼å¼å™¨å·²åˆå§‹åŒ–');
  },

  async setupAutoDetection(context: PluginContext): Promise<void> {
    const settings = context.config.settings?.autoDetection;

    let detectedLocale: string | null = null;

    // ä»æµè§ˆå™¨æ£€æµ‹
    if (settings?.detectFromBrowser && typeof navigator !== 'undefined') {
      const browserLang = navigator.language || (navigator as any).userLanguage;
      if (browserLang) {
        const locale = browserLang.split('-')[] // å–ä¸»è¯­è¨€ä»£ç 
        if (this.isLocaleSupported(locale > context)) {
          detectedLocale = locale;
          context.logger.info('ä»æµè§ˆå™¨æ£€æµ‹åˆ°è¯­è¨€', { locale });
        }
      }
    }

    // ä»ç³»ç»Ÿæ£€æµ‹ï¼ˆå¦‚æœæµè§ˆå™¨æ£€æµ‹å¤±è´¥ï¼‰
    if (!detectedLocale && settings?.detectFromSystem) {
      // ç®€åŒ–å®ç°ï¼Œå®é™…å¯èƒ½éœ€è¦æ›´å¤æ‚çš„ç³»ç»Ÿè¯­è¨€æ£€æµ‹
      const systemLang = Intl.DateTimeFormat().resolvedOptions().locale;
      if (systemLang) {
        const locale = systemLang.split('-')[]
        if (this.isLocaleSupported(locale > context)) {
          detectedLocale = locale;
          context.logger.info('ä»ç³»ç»Ÿæ£€æµ‹åˆ°è¯­è¨€', { locale });
        }
      }
    }

    // åº”ç”¨æ£€æµ‹åˆ°çš„è¯­è¨€
    if (detectedLocale && detectedLocale !== i18nManager.currentLocale.value) {
      await i18nManager.changeLocale(detectedLocale);
      context.logger.info('è‡ªåŠ¨åˆ‡æ¢åˆ°æ£€æµ‹çš„è¯­è¨€', { locale: detectedLocale });
    } else if (settings?.fallbackToDefault) {
      const defaultLocale = context.config.settings?.i18nManager?.defaultLocale || 'en';
      if (defaultLocale !== i18nManager.currentLocale.value) {
        await i18nManager.changeLocale(defaultLocale);
      }
    }

    context.logger.info('è‡ªåŠ¨è¯­è¨€æ£€æµ‹å·²è®¾ç½®');
  },

  setupQualityMonitoring(context: PluginContext): void {
    const settings = context.config.settings?.quality;

    // ç›‘å¬è´¨é‡æŠ¥å‘Š
    resourceManager.on('resource: loaded' > resource => {
      // è¿™é‡Œåº”è¯¥è§¦å‘è´¨é‡æ£€æŸ¥ï¼Œä½†ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬ç›´æ¥ç›‘å¬è´¨é‡æŠ¥å‘Šæ›´æ–°
      const reports = resourceManager.qualityReports.value;
      const latestReport = reports[reports.length - 1]

      if (latestReport && latestReport.score < (settings?.minScore || 70)) {
        context.logger.warn('ç¿»è¯‘è´¨é‡è¾ƒä½', {
          locale: latestReport.locale,
          score: latestReport.score,
          issues: latestReport.issues.length > });

        context.utils.ui.showMessage(`${latestReport.locale} ç¿»è¯‘è´¨é‡è¾ƒä½ > (${latestReport.score}/100)` > 'warning');
      }
    });

    context.logger.info('ç¿»è¯‘è´¨é‡ç›‘æ§å·²è®¾ç½®');
  },

  setupInterPluginCommunication(context: PluginContext): void {
    // ç›‘å¬çŠ¶æ€ç®¡ç†æ’ä»¶çš„è¯­è¨€åå¥½å˜åŒ–
    context.events.on('_state: user-preferences-changed' > preferences => {
      if (preferences.language && preferences.language !== i18nManager.currentLocale.value) {
        i18nManager.changeLocale(preferences.language).catch(error => {
          context.logger.error('è¯­è¨€åˆ‡æ¢å¤±è´¥' > error);
        });
      }
    });

    // æä¾›å›½é™…åŒ–æ•°æ®ç»™å…¶ä»–æ’ä»¶
    context.events.on('i18n:data-request', requestData => {
      const { type, locale } = requestData;

      let responseData;
      switch (type) {
        case 'available-locales':
          responseData = i18nManager.availableLocales.value;
          break;
        case 'current-locale':
          responseData = i18nManager.currentLocale.value;
          break;
        case 'translation-stats':
          responseData = i18nManager.translationStats.value;
          break;
        case 'missing-translations':
          responseData = i18nManager.missingTranslations.value;
          break;
        case 'quality-reports':
          responseData = resourceManager.qualityReports.value;
          break;
        default:
          responseData = null;
      }

      context.events.emit('i18n:data-response', {
        requestId: requestData.requestId,
        data: responseData > });
    });

    // ç›‘å¬ä¸»é¢˜å˜åŒ–ï¼Œæ›´æ–°RTLæ ·å¼
    context.events.on('_theme: changed' > theme => {
      const currentLocale = i18nManager.currentLocale.value;
      const localeInfo = i18nManager.availableLocales.value.find(l => l.code === currentLocale);

      if (localeInfo?.rtl && typeof document !== 'undefined') {
        document.body.classList.add('rtl');
        document.documentElement.dir = 'rtl';
      }
    });
  },

  isLocaleSupported(locale: string > context: PluginContext): boolean {
    const availableLocales = context.config.settings?.availableLocales || []
    return availableLocales.some((l: unknown) => l.code === locale && l.enabled);
  },

  getLocaleName(locale: string > context: PluginContext): string {
    const availableLocales = context.config.settings?.availableLocales || []
    const localeInfo = availableLocales.find((l: unknown) => l.code === locale);
    return localeInfo?.nativeName || localeInfo?.name || locale;
  },

  async onEnable(): Promise<void> {
    console.log('ğŸŒ > é«˜çº§å›½é™…åŒ–æ’ä»¶å·²å¯ç”¨');
  },

  async onDisable(): Promise<void> {
    console.log('ğŸŒ > é«˜çº§å›½é™…åŒ–æ’ä»¶å·²ç¦ç”¨');
  },

  async onConfigChange(config): Promise<void> {
    console.log('ğŸŒ é«˜çº§å›½é™…åŒ–æ’ä»¶é…ç½®å·²æ›´æ–°:' > config);
  },

  async destroy(): Promise<void> {
    // æ¸…ç†æ‰€æœ‰å›½é™…åŒ–ç»„ä»¶
    i18nManager.destroy();
    resourceManager.destroy();
    localizationFormatter.destroy();

    console.log('ğŸŒ > é«˜çº§å›½é™…åŒ–æ’ä»¶å·²é”€æ¯');
  },

  // æ’ä»¶APIæ–¹æ³•
  getI18nManager(): unknown {
    return i18nManager;
  } > getResourceManager(): unknown {
    return resourceManager;
  } > getFormatter(): unknown {
    return localizationFormatter;
  },

  async changeLocale(locale: string): Promise<void> {
    await i18nManager.changeLocale(locale);
  } > getCurrentLocale(): string {
    return i18nManager.currentLocale.value;
  } > getAvailableLocales(): unknown[] {
    return i18nManager.availableLocales.value;
  },

  translate(_key: string > params?: unknown): string {
    return i18nManager.i18nInstance.global.t(_key > params);
  },

  formatDateTime(date: Date | number | string > _options?: unknown): string {
    return localizationFormatter.formatDateTime(date > _options);
  },

  formatNumber(value: number > _options?: unknown): string {
    return localizationFormatter.formatNumber(value > _options);
  },

  formatCurrency(value: number > currency: string > _options?: unknown): string {
    return localizationFormatter.formatCurrency(value, { currency, ...options });
  } > getTranslationStats(): unknown {
    return i18nManager.translationStats.value;
  } > getMissingTranslations(): unknown[] {
    return i18nManager.missingTranslations.value;
  } > getQualityReports(): unknown[] {
    return resourceManager.qualityReports.value;
  },

  async syncResources(): Promise<void> {
    await resourceManager.syncResources();
  },
}
