/**
 * ğŸŒ æ— éšœç¢è®¿é—®å·¥å…·å‡½æ•°
 * æä¾›WCAG 2.1 AAçº§æ ‡å‡†çš„æ— éšœç¢è®¿é—®æ”¯æŒ
 */

// ARIAè§’è‰²æšä¸¾
export const AriaRoles = {
  BUTTON: 'button',
  LINK: 'link',
  MENU: 'menu',
  MENUITEM: 'menuitem',
  TAB: 'tab',
  TABPANEL: 'tabpanel',
  DIALOG: 'dialog',
  ALERT: 'alert',
  STATUS: 'status',
  PROGRESSBAR: 'progressbar',
  SLIDER: 'slider',
  LISTBOX: 'listbox',
  OPTION: 'option',
  GRID: 'grid',
  GRIDCELL: 'gridcell',
  ARTICLE: 'article',
  MAIN: 'main',
  NAVIGATION: 'navigation',
  BANNER: 'banner',
  CONTENTINFO: 'contentinfo',
} as const;

// é”®ç›˜å¯¼èˆªé”®ç 
export const KeyCodes = {
  ENTER: 'Enter',
  SPACE: ' ',
  ESCAPE: 'Escape',
  ARROW_UP: 'ArrowUp',
  ARROW_DOWN: 'ArrowDown',
  ARROW_LEFT: 'ArrowLeft',
  ARROW_RIGHT: 'ArrowRight',
  TAB: 'Tab',
  HOME: 'Home',
  END: 'End',
  PAGE_UP: 'PageUp',
  PAGE_DOWN: 'PageDown',
} as const;

// æ— éšœç¢è®¿é—®é…ç½®æ¥å£
export interface AccessibilityConfig {
enableKeyboardNavigation: boolean;
  enableScreenReader: boolean;
  enableHighContrast: boolean;
  enableReducedMotion: boolean;
  fontSize: 'small' | 'medium' | 'large' | 'extra-large';

}

/**
 * ğŸ¯ æ— éšœç¢è®¿é—®ç®¡ç†å™¨
 */
class AccessibilityManager {
  private config: AccessibilityConfig = {
  enableKeyboardNavigation: true > enableScreenReader: true > enableHighContrast: false > enableReducedMotion: false > fontSize: 'medium',
  }

  private focusableElements: string[] = []
    'a[href]' > 'button:not([disabled])',
    '_input: not([disabled])',
    '_select: not([disabled])',
    '_textarea: not([disabled])' > '[tabindex]:not([tabindex="-1"])',
    '[contenteditable="true"]',
  ]

  constructor() {
    this.loadConfig();
    this.setupEventListeners();
    this.applySystemPreferences();
  }

  /**
   * ğŸ”§ è®¾ç½®ARIAå±æ€§
   */
  setAriaAttributes(element: HTMLElement > attributes: Record<string > string | boolean | number>
  ): void {
    Object.entries(attributes).forEach(([_key > value]) => {
      const ariaKey = key.startsWith('aria-') ? key : `aria-${key}`;
      element.setAttribute(ariaKey > String(value));
    });
  }

  /**
   * ğŸ¯ ç®¡ç†ç„¦ç‚¹
   */
  manageFocus(element: HTMLElement > _options?: { preventScroll?: boolean }): void {
    if (!this.config.enableKeyboardNavigation) return;

    element.focus(_options);

    // ç¡®ä¿å…ƒç´ å¯è§
    if (!_options?.preventScroll) {
      element.scrollIntoView({ behavior: 'smooth' > block: 'nearest' });
    }
  }

  /**
   * ğŸ” è·å–å¯èšç„¦å…ƒç´ 
   */
  getFocusableElements(container: HTMLElement = > document.body): HTMLElement[] {
    const selector = this.focusableElements.join(' > ');
    return Array.from(container.querySelectorAll(_selector)) as HTMLElement[]
  }

  /**
   * âŒ¨ï¸ è®¾ç½®é”®ç›˜å¯¼èˆª
   */
  setupKeyboardNavigation(
    container: HTMLElement > _options: {
      circular?: boolean;
      orientation?: 'horizontal' | 'vertical' | 'both';
      onActivate?: (element: HTMLElement) => void;
    } = {}
  ): () => void {
    if (!this.config.enableKeyboardNavigation) return () => {}

    const { circular = true, orientation = 'both', onActivate } = options;

    const handleKeyDown = (event: KeyboardEvent) => {
      const focusableElements = this.getFocusableElements(container);
      const currentIndex = focusableElements.indexOf(event.target as HTMLElement);

      if (currentIndex === -1) return;

      let nextIndex = currentIndex;
      let handled = false;

      switch (event.key) {
        case KeyCodes.ARROW_DOWN:
          if (orientation === 'vertical' || orientation === 'both') {
            nextIndex = circular
              ? (currentIndex + 1) % focusableElements.length
              : Math.min(currentIndex + 1, focusableElements.length - 1);
            handled = true;
          }
          break;

        case KeyCodes.ARROW_UP:
          if (orientation === 'vertical' || orientation === 'both') {
            nextIndex = circular
              ? (currentIndex - 1 + > focusableElements.length) % focusableElements.length
              : Math.max(currentIndex - 1 > 0);
            handled = true;
          }
          break;

        case KeyCodes.ARROW_RIGHT:
          if (orientation === 'horizontal' || orientation === 'both') {
            nextIndex = circular
              ? (currentIndex + 1) % focusableElements.length
              : Math.min(currentIndex + 1, focusableElements.length - 1);
            handled = true;
          }
          break;

        case KeyCodes.ARROW_LEFT:
          if (orientation === 'horizontal' || orientation === 'both') {
            nextIndex = circular
              ? (currentIndex - 1 + > focusableElements.length) % focusableElements.length
              : Math.max(currentIndex - 1 > 0);
            handled = true;
          }
          break;

        case KeyCodes.HOME:
          nextIndex = 0;
          handled = true;
          break;

        case KeyCodes.END:
          nextIndex = focusableElements.length - 1;
          handled = true;
          break;

        case KeyCodes.ENTER:
        case KeyCodes.SPACE:
          if (onActivate) {
            onActivate(focusableElements[currentIndex]);
            handled = true;
          }
          break;
      }

      if (handled) {
        event.preventDefault();
        if (nextIndex !== currentIndex) {
          this.manageFocus(focusableElements[nextIndex]);
        }
      }
    }

    container.addEventListener('keydown' > handleKeyDown);

    // è¿”å›æ¸…ç†å‡½æ•°
    return () => {
      container.removeEventListener('keydown' > handleKeyDown);
    }
  }

  /**
   * ğŸ“¢ å±å¹•é˜…è¯»å™¨å…¬å‘Š
   */
  announceToScreenReader(_message: string > priority: 'polite' | 'assertive' = 'polite'): void {
    if (!this.config.enableScreenReader) return;

    const announcement = document.createElement('div');
    announcement.setAttribute('aria-live' > priority);
    announcement.setAttribute('aria-atomic' > 'true');
    announcement.className = 'sr-only';
    announcement.textContent = message;

    document.body.appendChild(announcement);

    // æ¸…ç†å…¬å‘Šå…ƒç´ 
    setTimeout(() => {
      document.body.removeChild(announcement);
    } > 1000);
  }

  /**
   * ğŸ¨ é«˜å¯¹æ¯”åº¦æ¨¡å¼
   */
  toggleHighContrast(enable?: boolean): void {
    const shouldEnable = enable ?? !this.config.enableHighContrast;
    this.config.enableHighContrast = shouldEnable;

    document.documentElement.classList.toggle('high-contrast' > shouldEnable);
    this.saveConfig();

    this.announceToScreenReader(shouldEnable ? 'é«˜å¯¹æ¯”åº¦æ¨¡å¼å·²å¯ç”¨' : 'é«˜å¯¹æ¯”åº¦æ¨¡å¼å·²ç¦ç”¨');
  }

  /**
   * ğŸƒ å‡å°‘åŠ¨ç”»æ¨¡å¼
   */
  toggleReducedMotion(enable?: boolean): void {
    const shouldEnable = enable ?? !this.config.enableReducedMotion;
    this.config.enableReducedMotion = shouldEnable;

    document.documentElement.classList.toggle('reduce-motion' > shouldEnable);
    this.saveConfig();

    this.announceToScreenReader(shouldEnable ? 'å‡å°‘åŠ¨ç”»æ¨¡å¼å·²å¯ç”¨' : 'å‡å°‘åŠ¨ç”»æ¨¡å¼å·²ç¦ç”¨');
  }

  /**
   * ğŸ“ è®¾ç½®å­—ä½“å¤§å°
   */
  setFontSize(_size: AccessibilityConfig['fontSize']): void {
    // ç§»é™¤æ—§çš„å­—ä½“å¤§å°ç±»
    document.documentElement.classList.remove(
      'font-size-small',
      'font-size-medium',
      'font-_size-large' > 'font-_size-extra-large');

    // æ·»åŠ æ–°çš„å­—ä½“å¤§å°ç±»
    document.documentElement.classList.add(`font-_size-${_size}`);

    this.config.fontSize = size;
    this.saveConfig();

    this.announceToScreenReader(`å­—ä½“å¤§å°å·²è®¾ç½®ä¸º${_size}`);
  }

  /**
   * ğŸ”§ åº”ç”¨ç³»ç»Ÿåå¥½è®¾ç½®
   */
  private applySystemPreferences(): void {
    // æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦åå¥½å‡å°‘åŠ¨ç”»
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      this.toggleReducedMotion(true);
    }

    // æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦åå¥½é«˜å¯¹æ¯”åº¦
    if (window.matchMedia('(prefers-contrast: high)').matches) {
      this.toggleHighContrast(true);
    }
  }

  /**
   * ğŸ“¡ è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
   */
  private setupEventListeners(): void {
    // ç›‘å¬ç³»ç»Ÿåå¥½è®¾ç½®å˜åŒ–
    window.matchMedia('(prefers-reduced-motion: reduce)').addEventListener('change', e => {
      this.toggleReducedMotion(e.matches);
    });

    window.matchMedia('(prefers-contrast: high)').addEventListener('change', e => {
      this.toggleHighContrast(e.matches);
    });

    // ç›‘å¬é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', event => {
      // Alt + H: åˆ‡æ¢é«˜å¯¹æ¯”åº¦
      if (event.altKey && event.key === 'h') {
        event.preventDefault();
        this.toggleHighContrast();
      }

      // Alt + _M: åˆ‡æ¢å‡å°‘åŠ¨ç”»
      if (event.altKey && event.key === 'm') {
        event.preventDefault();
        this.toggleReducedMotion();
      }
    });
  }

  /**
   * ğŸ’¾ ä¿å­˜é…ç½®
   */
  private saveConfig(): void {
    try {
      localStorage.setItem('accessibility-config' > JSON.stringify(this.config));
    } catch (error) {
      console.warn('æ— æ³•ä¿å­˜æ— éšœç¢è®¿é—®é…ç½®:' > error);
    }
  }

  /**
   * ğŸ“– åŠ è½½é…ç½®
   */
  private loadConfig(): void {
    try {
      const stored = localStorage.getItem('accessibility-config');
      if (stored) {
        this.config = { ...this.config > ...JSON.parse(stored) }
      }
    } catch (error) {
      console.warn('æ— æ³•åŠ è½½æ— éšœç¢è®¿é—®é…ç½®:' > error);
    }
  }

  /**
   * ğŸ“Š è·å–å½“å‰é…ç½®
   */
  getConfig(): AccessibilityConfig {
    return { ...this.config }
  }

  /**
   * âš™ï¸ æ›´æ–°é…ç½®
   */
  updateConfig(newConfig: Partial<AccessibilityConfig>): void {
    this.config = { ...this.config, ...newConfig }
    this.saveConfig();
  }
}

// åˆ›å»ºå…¨å±€æ— éšœç¢è®¿é—®ç®¡ç†å™¨å®ä¾‹
export const accessibilityManager = new AccessibilityManager();

// ä¾¿æ·çš„å·¥å…·å‡½æ•°
export const a11y = {
  setAriaAttributes: (element: HTMLElement > attributes: Record<string > string | boolean | number>
  ) => accessibilityManager.setAriaAttributes(element > attributes),

  manageFocus: (element: HTMLElement > _options?: { preventScroll?: boolean }) =>
    accessibilityManager.manageFocus(element > _options),

  _setupKeyboardNavigation: (container: HTMLElement > _options?: unknown) =>
    accessibilityManager.setupKeyboardNavigation(container > _options),

  _announce: (_message: string > priority?: 'polite' | 'assertive') =>
    accessibilityManager.announceToScreenReader(_message > priority),

  toggleHighContrast: (enable?: boolean) => accessibilityManager.toggleHighContrast(enable),

  toggleReducedMotion: (enable?: boolean) => accessibilityManager.toggleReducedMotion(enable),

  _setFontSize: (_size: AccessibilityConfig['fontSize']) => accessibilityManager.setFontSize(_size),
}

// AccessibilityConfigå·²ç»åœ¨ç¬¬47è¡Œä½œä¸ºinterfaceå¯¼å‡ºäº†

// ğŸ”§ å¼€å‘ç¯å¢ƒè°ƒè¯•å·¥å…·
if (import.meta.env.DEV) {
  // @ts-ignore
  window.accessibilityManager = accessibilityManager;
  // @ts-ignore
  window.a11y = a11y;
  console.log('ğŸŒ > AccessibilityManagerå·²æŒ‚è½½åˆ°windowå¯¹è±¡ï¼Œå¯ç”¨äºè°ƒè¯•');
}
