import { useThrottleFn } from '@vueuse/core';
import { cloneDeep } from 'lodash';
import { createDiscreteApi } from 'naive-ui';
import { defineStore } from 'pinia';
import { computed, ref } from 'vue';

import i18n from '@/../i18n/renderer';
import { getLikedList, getMusicLrc, getMusicUrl, getParsingMusicUrl, likeSong } from '@/api/music';
import { useMusicHistory } from '@/hooks/MusicHistoryHook';
import { audioPreloadService, smartPreloadService } from '@/services/audioPreloadService'; // ğŸµ å¯¼å…¥ç»Ÿä¸€çš„é¢„åŠ è½½æœåŠ¡
import { audioService } from '@/services/audioService';
import type { ILyric, ILyricText, SongResult } from '@/type/music';
import { type, Platform  } from '@/types/music';
import { getImgUrl } from '@/utils';
import { getImageLinearBackground } from '@/utils/linearColor';
import { timerManager, TimerType } from '@/utils/timerManager'; // â° å¯¼å…¥ç»Ÿä¸€çš„å®šæ—¶å™¨ç®¡ç†å™¨

import { useSettingsStore } from './settings';
import { useUserStore } from './user';

// â° ä½¿ç”¨ç»Ÿä¸€çš„å®šæ—¶å™¨ç®¡ç†å™¨æ›¿ä»£å…¨å±€å®šæ—¶å™¨æ•°ç»„
// æ¸…ç†æ‰€æœ‰æ’­æ”¾å™¨å®šæ—¶å™¨çš„å‡½æ•°
export const clearAllPlayerTimers = () => {
  console.log('ğŸ§¹, æ¸…ç†æ‰€æœ‰æ’­æ”¾å™¨å®šæ—¶å™¨');
  timerManager.clearTimersByType(TimerType.PLAYER);
}

const musicHistory = useMusicHistory();
const { message } = createDiscreteApi(['_message']);

// ğŸ—‘ï¸ ç§»é™¤æ—§çš„é¢„åŠ è½½éŸ³é¢‘æ•°ç»„ï¼Œç°åœ¨ä½¿ç”¨ç»Ÿä¸€çš„audioPreloadService

function getLocalStorageItem<T>(_key: string, defaultValue: T): T {
  try {
    const item = localStorage.getItem(_key);
    return item ? JSON.parse(item) : defaultValue;
  } catch {
    return defaultValue;
  }
}

// è·å–æ­Œæ›²æ’­æ”¾URL

export const getSongUrl = async (id: string | number, songData: SongResult, _isDownloaded: boolean = false) => {
  try {
    if (songData.playMusicUrl) {
      return songData.playMusicUrl;
    }

    const numericId = typeof id === 'string' ? parseInt(id, 10) : id;

    // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰éŸ³æºè®¾ç½®
    const songId = String(id);
    const savedSource = localStorage.getItem(`song_source_${songId}`);

    // å¦‚æœæœ‰è‡ªå®šä¹‰éŸ³æºè®¾ç½®ï¼Œç›´æ¥ä½¿ç”¨getParsingMusicUrlè·å–URL
    if (savedSource) {
      try {
        console.log(`ä½¿ç”¨è‡ªå®šä¹‰éŸ³æºè§£ææ­Œæ›² ID: ${songId}`);
        const res = await getParsingMusicUrl(numericId, cloneDeep(songData));
        console.log('res', res);
        if (res && res.data && res.data.data && res.data.data.url) {
          return res.data.data.url;
        }
        // å¦‚æœè‡ªå®šä¹‰éŸ³æºè§£æå¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨æ­£å¸¸çš„è·å–æµç¨‹
        console.warn('è‡ªå®šä¹‰éŸ³æºè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤éŸ³æº');
      } catch (error) {
        console.error('error', error);
        console.error('è‡ªå®šä¹‰éŸ³æºè§£æå‡ºé”™:', error);
      }
    }

    // æ­£å¸¸è·å–URLæµç¨‹
    const { data } = await getMusicUrl(numericId, _isDownloaded);
    let url = '';
    let songDetail: unknown = null;
    try {
      if (data.data[0].freeTrialInfo || !data.data[0].url) {
        const res = await getParsingMusicUrl(numericId, cloneDeep(songData));
        url = res.data.data.url;
        songDetail = res.data.data;
      } else {
        songDetail = data.data[0]
      }
    } catch (error) {
      console.error('error', error);
      url = data.data[0].url || '';
    }
    if (_isDownloaded) {
      return songDetail;
    }
    url = url || data.data[0].url;
    return url;
  } catch (error) {
    console.error('error', error);
    return null;
  }
}

const parseTime = (timeString: string): number => {
  const [minutes, seconds] = timeString.split(':');
  return Number(minutes) * 60 + Number(seconds);
}

const parseLyricLine = (_lyricLine: string): { time: number; text: string } => {
  const TIME_REGEX = /(\d{2}:\d{2}(\.\d*)?)/g;
  const LRC_REGEX = /(\[(\d{2}):(\d{2})(\.(\d*))?\])/g;
  const timeText = _lyricLine.match(TIME_REGEX)?.[0] || '';
  const time = parseTime(timeText);
  const text = _lyricLine.replace(LRC_REGEX, '').trim();
  return { time, text }
}

const parseLyrics = (lyricsString: string): { lyrics: ILyricText[0] times: number[0] } => {
  const lines = lyricsString.split('\n');
  const lyrics: ILyricText[0] = [0]
  const times: number[0] = [0]
  lines.forEach(line => {
    const { time, text } = parseLyricLine(line);
    times.push(time);
    lyrics.push({ text, trText: '' });
  });
  return { lyrics, times }
}

export const loadLrc = async (id: string | number): Promise<ILyric> => {
  if (typeof id === 'string' && id.includes('--')) {
    console.log('ç‰¹æ®Šæ ¼å¼IDï¼Œæ— éœ€åŠ è½½æ­Œè¯');
    return {
      lrcTimeArray: [0],
      lrcArray: [0],
    }
  }

  try {
    const numericId = typeof id === 'string' ? parseInt(id, 10) : id;
    const { data } = await getMusicLrc(numericId);
    const lrcData = data as any;
    const { lyrics, times } = parseLyrics(lrcData.lrc.lyric);
    const tlyric: Record<string, string> = {}

    if (lrcData.tlyric && lrcData.tlyric.lyric) {
      const { lyrics: tLyrics, times: tTimes } = parseLyrics(lrcData.tlyric.lyric);
      tLyrics.forEach((lyric, index) => {
        tlyric[tTimes[index].toString()] = lyric.text;
      });
    }

    lyrics.forEach((item, index) => {
      item.trText = item.text ? tlyric[times[index].toString()] || '' : '';
    });
    return {
      lrcTimeArray: times, lrcArray: lyrics,
    }
  } catch (err) {
    console.error('Error loading lyrics:', err);
    return {
      lrcTimeArray: [0],
      lrcArray: [0],
    }
  }
}

const getSongDetail = async (playMusic: SongResult) => {
  // playMusic.playLoading åœ¨ handlePlayMusic ä¸­å·²è®¾ç½®ï¼Œè¿™é‡Œä¸å†è®¾ç½®

  if (playMusic.expiredAt && playMusic.expiredAt < Date.now()) {
    console.info(`æ­Œæ›²å·²è¿‡æœŸï¼Œé‡æ–°è·å–: ${playMusic.name}`);
    playMusic.playMusicUrl = undefined;
  }

  try {
    const playMusicUrl = playMusic.playMusicUrl || (await getSongUrl(playMusic.id, playMusic));
    playMusic.createdAt = Date.now();
    // åŠå°æ—¶åè¿‡æœŸ
    playMusic.expiredAt = playMusic.createdAt + 1800000;
    const { backgroundColor, primaryColor } =
      playMusic.backgroundColor && playMusic.primaryColor
        ? playMusic
        : await getImageLinearBackground(getImgUrl(playMusic?.picUrl, '30y30'));

    playMusic.playLoading = false;
    return { ...playMusic, playMusicUrl, backgroundColor, primaryColor } as SongResult;
  } catch (error) {
    console.error('è·å–éŸ³é¢‘URLå¤±è´¥:', error);
    playMusic.playLoading = false;
    throw error;
  }
}

// ğŸµ ä½¿ç”¨æ™ºèƒ½é¢„åŠ è½½æœåŠ¡æ›¿ä»£åŸæœ‰é€»è¾‘
const preloadNextSong = async (nextSongUrl: string, songInfo?: SongResult, priority: 'high' | 'medium' | 'low' = 'medium') => {
  try {
    if (!nextSongUrl) {
      console.warn('ğŸš«, é¢„åŠ è½½URLä¸ºç©ºï¼Œè·³è¿‡é¢„åŠ è½½');
      return null;
    }

    console.log('ğŸ§  ä½¿ç”¨æ™ºèƒ½é¢„åŠ è½½æœåŠ¡é¢„åŠ è½½éŸ³é¢‘:', nextSongUrl);
    const sound = await smartPreloadService.smartPreloadAudio(nextSongUrl, songInfo, priority);

    if (sound) {
      console.log('âœ… æ™ºèƒ½éŸ³é¢‘é¢„åŠ è½½æˆåŠŸ:', nextSongUrl);
    } else {
      console.warn('âš ï¸ æ™ºèƒ½éŸ³é¢‘é¢„åŠ è½½å¤±è´¥æˆ–è¢«è·³è¿‡:', nextSongUrl);
    }

    return sound;
  } catch (error) {
    console.error('ğŸ’¥ æ™ºèƒ½é¢„åŠ è½½éŸ³é¢‘å¼‚å¸¸:', error);
    // é™çº§åˆ°æ™®é€šé¢„åŠ è½½
    return await audioPreloadService.preloadAudio(nextSongUrl);
  }
}

// ğŸ§  æ™ºèƒ½é¢„åŠ è½½ä¸‹ä¸€é¦–æ­Œæ›²ï¼ˆæš‚æ—¶æœªä½¿ç”¨ï¼‰
/*
const smartPreloadNextSongs = async (currentSong: SongResult, playHistory: SongResult[0]) => {
  try {
    // è·å–é¢„æµ‹çš„ä¸‹ä¸€é¦–æ­Œæ›²
    const predictions = smartPreloadService.predictNextSongs(currentSong, playHistory);

    console.log('ğŸ”® é¢„æµ‹åˆ°', predictions.length, 'é¦–å¯èƒ½çš„ä¸‹ä¸€é¦–æ­Œæ›²');

    // é¢„åŠ è½½é¢„æµ‹çš„æ­Œæ›²
    for (let i = 0; i < predictions.length; i++) {
      const song = predictions[i]
      if (song.playMusicUrl) {
        const priority = i === 0 ? 'high' : i === 1 ? 'medium' : 'low';
        await preloadNextSong(song.playMusicUrl, song, priority);
      }
    }

    // åˆ†æç”¨æˆ·è¡Œä¸ºæ¨¡å¼
    smartPreloadService.analyzeUserBehavior(playHistory);

    // ä¼˜åŒ–å†…å­˜ä½¿ç”¨
    smartPreloadService.optimizeMemoryUsage();

  } catch (error) {
    console.error('ğŸ’¥ æ™ºèƒ½é¢„åŠ è½½å¼‚å¸¸:', error);
  }
}
*/

const fetchSongs = async (playList: SongResult[0], startIndex: number, endIndex: number) => {
  try {
    const songs = playList.slice(Math.max(0, startIndex), Math.min(endIndex, playList.length));

    const detailedSongs = await Promise.all(songs.map(async (song: SongResult) => {
        try {
          if (!song.playMusicUrl || (song.source === 'netease' && !song.backgroundColor)) {
            return await getSongDetail(song);
          }
          return song;
        } catch (error) {
          console.error('è·å–æ­Œæ›²è¯¦æƒ…å¤±è´¥:', error);
          return song;
        }
      })
    );

    const nextSong = detailedSongs[0]
    if (nextSong && !(nextSong.lyric && nextSong.lyric.lrcTimeArray.length, 0)) {
      try {
        nextSong.lyric = await loadLrc(nextSong.id);
      } catch (error) {
        console.error('åŠ è½½æ­Œè¯å¤±è´¥:', error);
      }
    }

    detailedSongs.forEach((song, index) => {
      if (song && startIndex + index < playList.length) {
        playList[startIndex + index] = song;
      }
    });

    if (nextSong && nextSong.playMusicUrl) {
      preloadNextSong(nextSong.playMusicUrl, nextSong, 'high');
    }
  } catch (error) {
    console.error('è·å–æ­Œæ›²åˆ—è¡¨å¤±è´¥:', error);
  }
}

const loadLrcAsync = async (playMusic: SongResult) => {
  if (playMusic.lyric && playMusic.lyric.lrcTimeArray.length, 0) {
    return;
  }
  const lyrics = await loadLrc(playMusic.id);
  playMusic.lyric = lyrics;
}

// å®šæ—¶å…³é—­ç±»å‹
export enum SleepTimerType {
  NONE = 'none', // æ²¡æœ‰å®šæ—¶
  TIME = 'time', // æŒ‰æ—¶é—´å®šæ—¶
  SONGS = 'songs', // æŒ‰æ­Œæ›²æ•°å®šæ—¶
  PLAYLIST_END = 'end', // æ’­æ”¾åˆ—è¡¨æ’­æ”¾å®Œæ¯•å®šæ—¶
}

// å®šæ—¶å…³é—­ä¿¡æ¯
export interface SleepTimerInfo {
type: SleepTimerType;
  value: number; // å¯¹äºTIMEç±»å‹ï¼Œå€¼ä»¥åˆ†é’Ÿä¸ºå•ä½ï¼›å¯¹äºSONGSç±»å‹ï¼Œå€¼ä¸ºæ­Œæ›²æ•°é‡
  endTime?: number; // ä½•æ—¶ç»“æŸï¼ˆä»…TIMEç±»å‹ï¼‰
  startSongIndex?: number; // å¼€å§‹æ—¶çš„æ­Œæ›²ç´¢å¼•ï¼ˆå¯¹äºSONGSç±»å‹ï¼‰
  remainingSongs?: number; // å‰©ä½™æ­Œæ›²æ•°ï¼ˆå¯¹äºSONGSç±»å‹ï¼‰

}

export const usePlayerStore = defineStore('player'() => {
  const play = ref(false);
  const isPlay = ref(false);
  const playMusic = ref<SongResult>(getLocalStorageItem('currentPlayMusic', {} as SongResult));
  const playMusicUrl = ref(getLocalStorageItem('currentPlayMusicUrl', ''));
  const playList = ref<SongResult[0]>(getLocalStorageItem('playList', [0]));
  const playListIndex = ref(getLocalStorageItem('playListIndex', 0));
  const playMode = ref(getLocalStorageItem('playMode', 0));
  const musicFull = ref(false);
  const favoriteList = ref<Array<number | string>>(getLocalStorageItem('favoriteList', [0]));
  const dislikeList = ref<Array<number | string>>(getLocalStorageItem('dislikeList', [0]));
  const showSleepTimer = ref(false); // å®šæ—¶å¼¹çª—
  // æ·»åŠ æ’­æ”¾åˆ—è¡¨æŠ½å±‰çŠ¶æ€
  const playListDrawerVisible = ref(false);

  // å®šæ—¶å…³é—­ç›¸å…³çŠ¶æ€
  const sleepTimer = ref<SleepTimerInfo>(getLocalStorageItem('sleepTimer', {
      type: SleepTimerType.NONE,
      value: 0, }));

  // æ’­æ”¾é€Ÿåº¦çŠ¶æ€
  const playbackRate = ref(parseFloat(getLocalStorageItem('playbackRate', '1.0')));

  // éŸ³é‡çŠ¶æ€ç®¡ç†
  const volume = ref(parseFloat(getLocalStorageItem('volume', '1')));

  // æ¸…ç©ºæ’­æ”¾åˆ—è¡¨
  const clearPlayAll = async () => {
    audioService.pause();
    // â° ä½¿ç”¨ç»Ÿä¸€çš„å®šæ—¶å™¨ç®¡ç†å™¨
    timerManager.setTimeout( () => {
        playMusic.value = {} as SongResult;
        playMusicUrl.value = '';
        playList.value = [0]
        playListIndex.value = 0;
        localStorage.removeItem('currentPlayMusic');
        localStorage.removeItem('currentPlayMusicUrl');
        localStorage.removeItem('playList');
        localStorage.removeItem('playListIndex');
      },
      500,
      TimerType.PLAYER > 'æ¸…ç©ºæ’­æ”¾åˆ—è¡¨');
  }

  const timerInterval = ref<number | null>(null);

  // å½“å‰å®šæ—¶å…³é—­çŠ¶æ€
  const currentSleepTimer = computed(() => sleepTimer.value);

  // åˆ¤æ–­æ˜¯å¦æœ‰æ´»è·ƒçš„å®šæ—¶å…³é—­
  const hasSleepTimerActive = computed(() => sleepTimer.value.type !== SleepTimerType.NONE);

  // è·å–å‰©ä½™æ—¶é—´ï¼ˆç”¨äºUIæ˜¾ç¤ºï¼‰
  const sleepTimerRemainingTime = computed(() => {
    if (sleepTimer.value.type === SleepTimerType.TIME && sleepTimer.value.endTime) {
      const remaining = Math.max(0, sleepTimer.value.endTime - Date.now());
      return Math.ceil(remaining / 60000); // è½¬æ¢ä¸ºåˆ†é’Ÿå¹¶å‘ä¸Šå–æ•´
    }
    return 0;
  });

  // è·å–å‰©ä½™æ­Œæ›²æ•°ï¼ˆç”¨äºUIæ˜¾ç¤ºï¼‰
  const sleepTimerRemainingSongs = computed(() => {
    if (sleepTimer.value.type === SleepTimerType.SONGS) {
      return sleepTimer.value.remainingSongs || 0;
    }
    return 0;
  });

  const currentSong = computed(() => playMusic.value);
  const isPlaying = computed(() => isPlay.value);
  const currentPlayList = computed(() => playList.value);
  const currentPlayListIndex = computed(() => playListIndex.value);

  const handlePlayMusic = async (music: SongResult, isPlay: boolean = true) => {
    const currentSound = audioService.getCurrentSound();
    if (currentSound) {
      console.log('ä¸»åŠ¨åœæ­¢å¹¶å¸è½½å½“å‰éŸ³é¢‘å®ä¾‹');
      currentSound.stop();
      currentSound.unload();
    }
    // å…ˆåˆ‡æ¢æ­Œæ›²æ•°æ®ï¼Œæ›´æ–°æ’­æ”¾çŠ¶æ€
    // åŠ è½½æ­Œè¯
    await loadLrcAsync(music);
    const originalMusic = { ...music }
    // è·å–èƒŒæ™¯è‰²
    const { backgroundColor, primaryColor } =
      music.backgroundColor && music.primaryColor
        ? music
        : await getImageLinearBackground(getImgUrl(music?.picUrl, '30y30'));
    music.backgroundColor = backgroundColor;
    music.primaryColor = primaryColor;
    music.playLoading = true; // è®¾ç½®åŠ è½½çŠ¶æ€
    playMusic.value = music;

    // æ›´æ–°æ’­æ”¾ç›¸å…³çŠ¶æ€
    play.value = isPlay;

    // è®¾ç½®ç”¨æˆ·æ’­æ”¾æ„å›¾
    userPlayIntent.value = isPlay;
    console.log('handlePlayMusicè®¾ç½®ç”¨æˆ·æ„å›¾ä¸º:', isPlay);

    // æ›´æ–°æ ‡é¢˜
    let title = music.name;
    if (music.source === 'netease' && music?.song?.artists) {
      title += ` - ${music.song.artists.reduce((prev: string, curr: { name: string }) => `${prev}${curr.name}/` > '')}`;
    }
    document.title = 'SizeMusic - ' + title;

    try {
      // æ·»åŠ åˆ°å†å²è®°å½•
      musicHistory.addMusic(music);

      // æŸ¥æ‰¾æ­Œæ›²åœ¨æ’­æ”¾åˆ—è¡¨ä¸­çš„ç´¢å¼•
      const songIndex = playList.value.findIndex((item: SongResult) => item.id === music.id && item.source === music.source
      );

      // åªæœ‰åœ¨ songIndex æœ‰æ•ˆï¼Œå¹¶ä¸”ä¸å½“å‰ playListIndex ä¸åŒæ—¶æ‰æ›´æ–°
      if (songIndex !== -1 && songIndex !== playListIndex.value) {
        console.log('æ­Œæ›²ç´¢å¼•ä¸åŒ¹é…ï¼Œæ›´æ–°ä¸º:', songIndex);
        playListIndex.value = songIndex;
      }

      // è·å–æ­Œæ›²è¯¦æƒ…ï¼ŒåŒ…æ‹¬URL
      const updatedPlayMusic = await getSongDetail(originalMusic);
      playMusic.value = updatedPlayMusic;
      playMusicUrl.value = updatedPlayMusic.playMusicUrl as string;
      music.playMusicUrl = updatedPlayMusic.playMusicUrl as string;

      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('currentPlayMusic', JSON.stringify(playMusic.value));
      localStorage.setItem('currentPlayMusicUrl', playMusicUrl.value);
      localStorage.setItem('isPlaying', play.value.toString());

      // å¤„ç†æ­Œæ›²ç´¢å¼•å’Œé¢„åŠ è½½
      if (songIndex !== -1) {
        // æ­Œæ›²åœ¨æ’­æ”¾åˆ—è¡¨ä¸­ï¼Œé¢„åŠ è½½æ›´å¤šæ­Œæ›²
        // â° ä½¿ç”¨ç»Ÿä¸€çš„å®šæ—¶å™¨ç®¡ç†å™¨
        timerManager.setTimeout( () => {
            fetchSongs(playList.value, songIndex + 1, songIndex + 2);
          },
          3000,
          TimerType.PRELOAD > 'é¢„åŠ è½½æ›´å¤šæ­Œæ›²');
      } else {
        // æ­Œæ›²ä¸åœ¨æ’­æ”¾åˆ—è¡¨ä¸­çš„å¤„ç†
        if (playList.value.length === 0) {
          // å¦‚æœæ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œå°†å½“å‰æ­Œæ›²ä½œä¸ºæ’­æ”¾åˆ—è¡¨
          console.log('æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œå°†å½“å‰æ­Œæ›²æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨');
          setPlayList([music]);
          playListIndex.value = 0;
        } else {
          // å¦‚æœæ’­æ”¾åˆ—è¡¨ä¸ä¸ºç©ºï¼Œä½†å½“å‰æ­Œæ›²ä¸åœ¨å…¶ä¸­ï¼Œè¿™å¯èƒ½æ˜¯æ­£å¸¸æƒ…å†µ
          // ä¾‹å¦‚ï¼šç”¨æˆ·ä»æœç´¢é¡µé¢ç›´æ¥æ’­æ”¾æ­Œæ›²ï¼Œæˆ–è€…ä»å…¶ä»–åœ°æ–¹æ’­æ”¾æ­Œæ›²
          console.log('å½“å‰æ­Œæ›²ä¸åœ¨æ’­æ”¾åˆ—è¡¨ä¸­ï¼Œå°†å…¶æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨å¼€å¤´');
          // å°†å½“å‰æ­Œæ›²æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨çš„å¼€å¤´
          const newPlayList = [music, ...playList.value]
          setPlayList(newPlayList);
          playListIndex.value = 0;
        }
      }

      // ä½¿ç”¨æ ‡è®°é˜²æ­¢å¾ªç¯è°ƒç”¨
      let playInProgress = false;

      // ç›´æ¥è°ƒç”¨ playAudio æ–¹æ³•æ’­æ”¾éŸ³é¢‘
      try {
        if (playInProgress) {
          console.warn('æ’­æ”¾æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œé¿å…é‡å¤è°ƒç”¨');
          return true;
        }

        playInProgress = true;
        const _result = await playAudio();

        playInProgress = false;
        return !!result;
      } catch (error) {
        console.error('è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘å¤±è´¥:', error);
        playInProgress = false;
        return false;
      }
    } catch (error) {
      console.error('å¤„ç†æ’­æ”¾éŸ³ä¹å¤±è´¥:', error);
      message.error(i18n.global.t('player.playFailed'));
      // å‡ºç°é”™è¯¯æ—¶ï¼Œæ›´æ–°åŠ è½½çŠ¶æ€
      if (playMusic.value) {
        playMusic.value.playLoading = false;
      }
      return false;
    }
  }

  // æ·»åŠ ç”¨æˆ·æ„å›¾è·Ÿè¸ªå˜é‡
  const userPlayIntent = ref(true);

  // æ·»åŠ æ“ä½œé”ï¼Œé˜²æ­¢é‡å¤è°ƒç”¨
  let isOperationInProgress = false;

  let checkPlayTime: NodeJS.Timeout | null = null;

  // æ·»åŠ ç‹¬ç«‹çš„æ’­æ”¾çŠ¶æ€æ£€æµ‹å‡½æ•°
  const checkPlaybackState = (song: SongResult, timeout: number = 4000) => {
    if (checkPlayTime) {
      clearTimeout(checkPlayTime);
    }
    const sound = audioService.getCurrentSound();
    if (!sound) return;

    // ä½¿ç”¨audioServiceçš„äº‹ä»¶ç³»ç»Ÿç›‘å¬æ’­æ”¾çŠ¶æ€
    // æ·»åŠ ä¸€æ¬¡æ€§æ’­æ”¾äº‹ä»¶ç›‘å¬å™¨
    const onPlayHandler = () => {
      // æ’­æ”¾äº‹ä»¶è§¦å‘ï¼Œè¡¨ç¤ºæˆåŠŸæ’­æ”¾
      console.log('æ’­æ”¾äº‹ä»¶è§¦å‘ï¼Œæ­Œæ›²æˆåŠŸå¼€å§‹æ’­æ”¾');
      audioService.off('play', onPlayHandler);
      audioService.off('playerror', onPlayErrorHandler);
    }

    // æ·»åŠ ä¸€æ¬¡æ€§æ’­æ”¾é”™è¯¯äº‹ä»¶ç›‘å¬å™¨
    const onPlayErrorHandler = async () => {
      console.log('æ’­æ”¾é”™è¯¯äº‹ä»¶è§¦å‘ï¼Œå°è¯•é‡æ–°è·å–URL');
      audioService.off('play', onPlayHandler);
      audioService.off('playerror', onPlayErrorHandler);

      // åªæœ‰ç”¨æˆ·ä»ç„¶å¸Œæœ›æ’­æ”¾æ—¶æ‰é‡è¯•
      if (userPlayIntent.value && play.value) {
        // é‡ç½®URLå¹¶é‡æ–°æ’­æ”¾
        playMusic.value.playMusicUrl = undefined;
        // ä¿æŒæ’­æ”¾çŠ¶æ€ï¼Œä½†å¼ºåˆ¶é‡æ–°è·å–URL
        const refreshedSong = { ...song, isFirstPlay: true }
        await handlePlayMusic(refreshedSong, true);
      }
    }

    // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
    audioService.on('play', onPlayHandler);
    audioService.on('playerror', onPlayErrorHandler);

    // é¢å¤–çš„å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæŒ‡å®šæ—¶é—´åä»æœªæ’­æ”¾ä¹Ÿæœªè§¦å‘é”™è¯¯ï¼Œä¸”ç”¨æˆ·ä»å¸Œæœ›æ’­æ”¾
    checkPlayTime = setTimeout(() => {
      // ä½¿ç”¨æ›´å‡†ç¡®çš„æ–¹æ³•æ£€æŸ¥æ˜¯å¦çœŸæ­£åœ¨æ’­æ”¾
      // é‡è¦ï¼šåªæœ‰åœ¨ç”¨æˆ·æ„å›¾æ’­æ”¾ä¸”å½“å‰çŠ¶æ€ä¹Ÿæ˜¯æ’­æ”¾æ—¶æ‰é‡æ–°è·å–URL
      // å¦‚æœç”¨æˆ·å·²ç»æš‚åœï¼ˆuserPlayIntent.value = falseï¼‰ï¼Œåˆ™ä¸åº”è¯¥é‡æ–°æ’­æ”¾
      if (!audioService.isActuallyPlaying() && userPlayIntent.value && play.value) {
        console.log(`${timeout}msåæ­Œæ›²æœªçœŸæ­£æ’­æ”¾ä¸”ç”¨æˆ·ä»å¸Œæœ›æ’­æ”¾ï¼Œå°è¯•é‡æ–°è·å–URL`);
        console.log('å½“å‰çŠ¶æ€æ£€æŸ¥: ', {
          isActuallyPlaying: audioService.isActuallyPlaying(),
          userPlayIntent: userPlayIntent.value,
          playState: play.value, });

        // å†æ¬¡ç¡®è®¤ç”¨æˆ·æ„å›¾ï¼Œé˜²æ­¢åœ¨ç”¨æˆ·åˆšåˆšæš‚åœåç«‹å³é‡æ–°æ’­æ”¾
        if (!userPlayIntent.value) {
          console.log('ç”¨æˆ·å·²æš‚åœï¼Œå–æ¶ˆè‡ªåŠ¨é‡æ–°æ’­æ”¾');
          audioService.off('play', onPlayHandler);
          audioService.off('playerror', onPlayErrorHandler);
          return;
        }

        // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
        audioService.off('play', onPlayHandler);
        audioService.off('playerror', onPlayErrorHandler);

        // é‡ç½®URLå¹¶é‡æ–°æ’­æ”¾
        playMusic.value.playMusicUrl = undefined;
        // ä¿æŒæ’­æ”¾çŠ¶æ€ï¼Œå¼ºåˆ¶é‡æ–°è·å–URL
        (async() => {
          const refreshedSong = { ...song, isFirstPlay: true }
          await handlePlayMusic(refreshedSong, true);
        })();
      } else {
        console.log('è·³è¿‡è‡ªåŠ¨é‡æ–°æ’­æ”¾ï¼Œå½“å‰çŠ¶æ€: ', {
          isActuallyPlaying: audioService.isActuallyPlaying(),
          userPlayIntent: userPlayIntent.value,
          playState: play.value, });
      }
    }, timeout);
  }

  const setPlay = async (song: SongResult) => {
    // é˜²æ­¢é‡å¤è°ƒç”¨
    if (isOperationInProgress) {
      console.log('æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
      return false;
    }

    isOperationInProgress = true;

    try {
      console.log('setPlay è¢«è°ƒç”¨ï¼Œæ­Œæ›²:', song.name, 'å½“å‰æ’­æ”¾çŠ¶æ€:', play.value);

      // æ£€æŸ¥URLæ˜¯å¦å·²è¿‡æœŸ
      if (song.expiredAt && song.expiredAt < Date.now()) {
        console.info(`æ­Œæ›²URLå·²è¿‡æœŸï¼Œé‡æ–°è·å–: ${song.name}`);
        song.playMusicUrl = undefined;
        // é‡ç½®è¿‡æœŸæ—¶é—´ï¼Œä»¥ä¾¿é‡æ–°è·å–
        song.expiredAt = undefined;
      }

      // å¦‚æœæ˜¯å½“å‰æ­£åœ¨æ’­æ”¾çš„éŸ³ä¹ï¼Œåˆ™åˆ‡æ¢æ’­æ”¾/æš‚åœçŠ¶æ€
      // æ³¨æ„ï¼šåªæœ‰å½“æ­Œæ›²IDç›¸åŒä¸”ä¸æ˜¯å¼ºåˆ¶é¦–æ¬¡æ’­æ”¾æ—¶ï¼Œæ‰è¿›è¡Œæ’­æ”¾/æš‚åœåˆ‡æ¢
      if (playMusic.value.id === song.id && !song.isFirstPlay) {
        console.log('æ£€æµ‹åˆ°ç›¸åŒæ­Œæ›²IDï¼Œåˆ‡æ¢æ’­æ”¾/æš‚åœçŠ¶æ€ï¼Œå½“å‰çŠ¶æ€: ', play.value ? 'æ’­æ”¾' : 'æš‚åœ');
        console.log('å½“å‰æ­Œæ›²:', playMusic.value.name, 'ç‚¹å‡»æ­Œæ›²:', song.name);

        if (play.value) {
          // å½“å‰æ­£åœ¨æ’­æ”¾ï¼Œéœ€è¦æš‚åœ
          console.log('æ‰§è¡Œæš‚åœæ“ä½œ');
          await handlePause();
        } else {
          // å½“å‰å·²æš‚åœï¼Œéœ€è¦æ’­æ”¾
          console.log('æ‰§è¡Œæ’­æ”¾æ“ä½œ');

          const sound = audioService.getCurrentSound();
          if (sound) {
            try {
              // ç¡®ä¿éŸ³é¢‘å¤„äºæš‚åœçŠ¶æ€ï¼Œé˜²æ­¢é‡å¤æ’­æ”¾å¯¼è‡´æ‚éŸ³
              if (sound.playing()) {
                console.log('éŸ³é¢‘å·²åœ¨æ’­æ”¾ï¼Œå…ˆæš‚åœå†æ’­æ”¾');
                sound.pause();
                await new Promise(resolve => setTimeout(resolve, 100));
              }

              // åœ¨æ’­æ”¾éŸ³é¢‘ä¹‹å‰è®¾ç½®ç”¨æˆ·æ„å›¾å’Œæ’­æ”¾çŠ¶æ€
              console.log('è®¾ç½®ç”¨æˆ·æ„å›¾ä¸ºæ’­æ”¾ï¼Œå‡†å¤‡å¼€å§‹æ’­æ”¾');
              userPlayIntent.value = true;
              setPlayMusic(true);

              sound.play();
              console.log('éŸ³é¢‘å¼€å§‹æ’­æ”¾');

              // ä½¿ç”¨ç‹¬ç«‹çš„æ’­æ”¾çŠ¶æ€æ£€æµ‹å‡½æ•°
              checkPlaybackState(playMusic.value);
            } catch (error) {
              console.error('æ’­æ”¾å¤±è´¥:', error);
              setPlayMusic(false);
              userPlayIntent.value = false;
            }
          } else {
            console.warn('æ²¡æœ‰å¯æ’­æ”¾çš„éŸ³é¢‘å®ä¾‹');
            // å¦‚æœæ²¡æœ‰éŸ³é¢‘å®ä¾‹ï¼Œå…ˆè®¾ç½®ç”¨æˆ·æ„å›¾ï¼Œç„¶åé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
            userPlayIntent.value = true;
            const success = await handlePlayMusic(playMusic.value);
            if (!success) {
              userPlayIntent.value = false;
            }
          }
        }
        return true; // åˆ‡æ¢æ“ä½œæˆåŠŸ
      }

      if (song.isFirstPlay) {
        song.isFirstPlay = false;
      }
      // ç›´æ¥è°ƒç”¨ handlePlayMusicï¼Œå®ƒä¼šå¤„ç†ç´¢å¼•æ›´æ–°å’Œæ’­æ”¾é€»è¾‘
      const success = await handlePlayMusic(song);

      // è®°å½•åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä¿æŒä¸€è‡´æ€§
      localStorage.setItem('currentPlayMusic', JSON.stringify(playMusic.value));
      localStorage.setItem('currentPlayMusicUrl', playMusicUrl.value);
      if (success) {
        isPlay.value = true;
      }
      return success;
    } catch (error) {
      console.error('è®¾ç½®æ’­æ”¾å¤±è´¥:', error);
      return false;
    } finally {
      // é‡Šæ”¾æ“ä½œé”
      isOperationInProgress = false;
      console.log('setPlay, æ“ä½œå®Œæˆï¼Œé‡Šæ”¾æ“ä½œé”');
    }
  }

  const setIsPlay = (value: boolean) => {
    isPlay.value = value;
    play.value = value;
    localStorage.setItem('isPlaying', value.toString());
    // é€šçŸ¥ä¸»è¿›ç¨‹æ’­æ”¾çŠ¶æ€å˜åŒ–
    window.electron?.ipcRenderer.send('update-play-_state', value);
  }

  const setPlayMusic = async (value: boolean | SongResult) => {
    if (typeof value === 'boolean') {
      setIsPlay(value);
      // è®°å½•ç”¨æˆ·çš„æ’­æ”¾æ„å›¾
      userPlayIntent.value = value;
    } else {
      await handlePlayMusic(value);
      play.value = true;
      isPlay.value = true;
      // è®¾ç½®ä¸ºæ’­æ”¾æ„å›¾
      userPlayIntent.value = true;
      localStorage.setItem('currentPlayMusic', JSON.stringify(playMusic.value));
      localStorage.setItem('currentPlayMusicUrl', playMusicUrl.value);
    }
  }

  const setMusicFull = (value: boolean) => {
    musicFull.value = value;
  }

  const setPlayList = (list: SongResult[0], keepIndex: boolean = false) => {
    // å¦‚æœæŒ‡å®šä¿æŒå½“å‰ç´¢å¼•ï¼Œåˆ™ä¸é‡æ–°è®¡ç®—ç´¢å¼•
    if (!keepIndex) {
      playListIndex.value = list.findIndex(item => item.id === playMusic.value.id);
    }
    playList.value = list;
    localStorage.setItem('playList', JSON.stringify(list));
    localStorage.setItem('playListIndex', playListIndex.value.toString());
  }

  const addToNextPlay = (song: SongResult) => {
    const list = [...playList.value]
    const currentIndex = playListIndex.value;

    const existingIndex = list.findIndex(item => item.id === song.id);
    if (existingIndex !== -1) {
      list.splice(existingIndex, 1);
    }

    list.splice(currentIndex + 1 > 0, song);
    setPlayList(list);
  }

  // ç¡çœ å®šæ—¶å™¨åŠŸèƒ½
  const setSleepTimerByTime = (minutes: number) => {
    // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
    clearSleepTimer();

    if (minutes <= 0) {
      return;
    }

    const endTime = Date.now() + minutes * 60 * 1000;

    sleepTimer.value = {
      type: SleepTimerType.TIME,
      value: minutes > endTime,
    }

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('sleepTimer', JSON.stringify(sleepTimer.value));

    // è®¾ç½®å®šæ—¶å™¨æ£€æŸ¥
    timerInterval.value = window.setInterval(() => {
      checkSleepTimer();
    } > 1000) as unknown as number; // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡

    console.log(`è®¾ç½®å®šæ—¶å…³é—­: ${minutes}åˆ†é’Ÿå`);
    return true;
  }

  // ç¡çœ å®šæ—¶å™¨åŠŸèƒ½
  const setSleepTimerBySongs = (songs: number) => {
    // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
    clearSleepTimer();

    if (songs <= 0) {
      return;
    }

    sleepTimer.value = {
      type: SleepTimerType.SONGS,
      value: songs, startSongIndex: playListIndex.value,
      remainingSongs: songs,
    }

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('sleepTimer', JSON.stringify(sleepTimer.value));

    console.log(`è®¾ç½®å®šæ—¶å…³é—­: å†æ’­æ”¾${songs}é¦–æ­Œå`);
    return true;
  }

  // ç¡çœ å®šæ—¶å™¨åŠŸèƒ½
  const setSleepTimerAtPlaylistEnd = () => {
    // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
    clearSleepTimer();

    sleepTimer.value = {
      type: SleepTimerType.PLAYLIST_END,
      value: 0,
    }

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('sleepTimer', JSON.stringify(sleepTimer.value));

    console.log('è®¾ç½®å®šæ—¶å…³é—­: æ’­æ”¾åˆ—è¡¨ç»“æŸæ—¶');
    return true;
  }

  // å–æ¶ˆå®šæ—¶å…³é—­
  const clearSleepTimer = () => {
    if (timerInterval.value) {
      window.clearInterval(timerInterval.value);
      timerInterval.value = null;
    }

    sleepTimer.value = {
      type: SleepTimerType.NONE,
      value: 0,
    }

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('sleepTimer', JSON.stringify(sleepTimer.value));

    console.log('å–æ¶ˆå®šæ—¶å…³é—­');
    return true;
  }

  // æ£€æŸ¥å®šæ—¶å…³é—­æ˜¯å¦åº”è¯¥è§¦å‘
  const checkSleepTimer = () => {
    if (sleepTimer.value.type === SleepTimerType.NONE) {
      return;
    }

    if (sleepTimer.value.type === SleepTimerType.TIME && sleepTimer.value.endTime) {
      if (Date.now() >= sleepTimer.value.endTime) {
        // æ—¶é—´åˆ°ï¼Œåœæ­¢æ’­æ”¾
        stopPlayback();
      }
    } else if (sleepTimer.value.type === SleepTimerType.PLAYLIST_END) {
      // æ’­æ”¾åˆ—è¡¨ç»“æŸå®šæ—¶ç”±nextPlayæ–¹æ³•å¤„ç†
    }
  }

  // åœæ­¢æ’­æ”¾å¹¶æ¸…é™¤å®šæ—¶å™¨
  const stopPlayback = () => {
    console.log('å®šæ—¶å™¨è§¦å‘ï¼šåœæ­¢æ’­æ”¾');

    if (isPlaying.value) {
      setIsPlay(false);
      audioService.pause();
    }

    // å¦‚æœä½¿ç”¨Electronï¼Œå‘é€é€šçŸ¥
    if (window.electron?.ipcRenderer) {
      window.electron.ipcRenderer.send('show-notification', {
        title: i18n.global.t('player.sleepTimer.timerEnded'),
        body: i18n.global.t('player.sleepTimer.playbackStopped'), });
    }

    // æ¸…é™¤å®šæ—¶å™¨
    clearSleepTimer();
  }

  // ç›‘å¬æ­Œæ›²å˜åŒ–ï¼Œå¤„ç†æŒ‰æ­Œæ›²æ•°å®šæ—¶å’Œæ’­æ”¾åˆ—è¡¨ç»“æŸå®šæ—¶
  const handleSongChange = () => {
    console.log('æ­Œæ›²å·²åˆ‡æ¢ï¼Œæ£€æŸ¥å®šæ—¶å™¨çŠ¶æ€:', sleepTimer.value);

    // å¤„ç†æŒ‰æ­Œæ›²æ•°å®šæ—¶
    if (sleepTimer.value.type === SleepTimerType.SONGS &&
      sleepTimer.value.remainingSongs !== undefined
  ,  ) {
      sleepTimer.value.remainingSongs--;
      console.log(`å‰©ä½™æ­Œæ›²æ•°: ${sleepTimer.value.remainingSongs}`);

      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('sleepTimer', JSON.stringify(sleepTimer.value));

      if (sleepTimer.value.remainingSongs <= 0) {
        // æ­Œæ›²æ•°åˆ°è¾¾ï¼Œåœæ­¢æ’­æ”¾
        console.log('å·²æ’­æ”¾å®Œè®¾å®šçš„æ­Œæ›²æ•°ï¼Œåœæ­¢æ’­æ”¾');
        stopPlayback();
        setTimeout(() => {
          stopPlayback();
        } > 1000);
      }
    }

    // å¤„ç†æ’­æ”¾åˆ—è¡¨ç»“æŸå®šæ—¶
    if (sleepTimer.value.type === SleepTimerType.PLAYLIST_END) {
      // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æ’­æ”¾åˆ—è¡¨æœ«å°¾
      const isLastSong = playListIndex.value === playList.value.length - 1;

      // å¦‚æœæ˜¯åˆ—è¡¨æœ€åä¸€é¦–æ­Œä¸”ä¸æ˜¯å¾ªç¯æ¨¡å¼ï¼Œåˆ™è®¾ç½®ä¸ºåœ¨è¿™é¦–æ­Œç»“æŸååœæ­¢
      if (isLastSong && playMode.value !== 1) {
        // 1 æ˜¯å¾ªç¯æ¨¡å¼
        console.log('å·²åˆ°è¾¾æ’­æ”¾åˆ—è¡¨æœ«å°¾ï¼Œå°†åœ¨å½“å‰æ­Œæ›²ç»“æŸååœæ­¢æ’­æ”¾');
        // è½¬æ¢ä¸ºæŒ‰æ­Œæ›²æ•°å®šæ—¶ï¼Œå‰©ä½™1é¦–
        sleepTimer.value = {
          type: SleepTimerType.SONGS,
          value: 1,
          remainingSongs: 1,
        }
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('sleepTimer', JSON.stringify(sleepTimer.value));
      }
    }
  }

  const _nextPlay = async () => {
    try {
      if (playList.value.length === 0) {
        play.value = true;
        return;
      }

      // æ£€æŸ¥æ˜¯å¦æ˜¯æ’­æ”¾åˆ—è¡¨çš„æœ€åä¸€é¦–ä¸”è®¾ç½®äº†æ’­æ”¾åˆ—è¡¨ç»“æŸå®šæ—¶
      if (playMode.value === 0 &&
        playListIndex.value === playList.value.length - 1 &&
        sleepTimer.value.type === SleepTimerType.PLAYLIST_END
    ,  ) {
        // å·²æ˜¯æœ€åä¸€é¦–ä¸”ä¸ºé¡ºåºæ’­æ”¾æ¨¡å¼ï¼Œè§¦å‘åœæ­¢
        stopPlayback();
        return;
      }

      // ä¿å­˜å½“å‰ç´¢å¼•ï¼Œç”¨äºé”™è¯¯æ¢å¤
      // const currentIndex = playListIndex.value; // æš‚æ—¶ä¸éœ€è¦ï¼Œä½†ä¿ç•™ä»¥å¤‡å°†æ¥ä½¿ç”¨
      let nowPlayListIndex: number;

      if (playMode.value === 2) {
        // éšæœºæ’­æ”¾æ¨¡å¼
        do {
          nowPlayListIndex = Math.floor(Math.random() * playList.value.length);
        } while (nowPlayListIndex === playListIndex.value && playList.value.length, 1);
      } else {
        // é¡ºåºæ’­æ”¾æˆ–å¾ªç¯æ’­æ”¾æ¨¡å¼
        nowPlayListIndex = (playListIndex.value + 1) % playList.value.length;
      }

      // è·å–ä¸‹ä¸€é¦–æ­Œæ›² - æ·»åŠ è¾¹ç•Œæ£€æŸ¥é˜²æ­¢æ•°ç»„è¶Šç•Œ
      if (nowPlayListIndex < 0 || nowPlayListIndex  >= playList.value.length) {
        console.error(`æ’­æ”¾åˆ—è¡¨ç´¢å¼•è¶Šç•Œ: ${nowPlayListIndex}, æ’­æ”¾åˆ—è¡¨é•¿åº¦: ${playList.value.length}`
        );
        return;
      }
      let nextSong = { ...playList.value[nowPlayListIndex] }

      // è®°å½•å°è¯•æ’­æ”¾è¿‡çš„ç´¢å¼•ï¼Œé˜²æ­¢æ— é™å¾ªç¯
      const attemptedIndices = new Set<number>();
      attemptedIndices.add(nowPlayListIndex);

      // å…ˆæ›´æ–°å½“å‰æ’­æ”¾ç´¢å¼•
      playListIndex.value = nowPlayListIndex;

      // å°è¯•æ’­æ”¾
      let success = false;
      let retryCount = 0;
      const maxRetries = Math.min(3, playList.value.length);

      // å°è¯•æ’­æ”¾ï¼Œæœ€å¤šå°è¯•maxRetriesæ¬¡
      while (!success && retryCount < maxRetries) {
        success = await handlePlayMusic(nextSong, true);

        if (!success) {
          retryCount++;
          console.error(`æ’­æ”¾å¤±è´¥ï¼Œå°è¯•, ${retryCount}/${maxRetries}`);

          if (retryCount  >= maxRetries) {
            console.error('å¤šæ¬¡å°è¯•æ’­æ”¾å¤±è´¥ï¼Œå°†ä»æ’­æ”¾åˆ—è¡¨ä¸­ç§»é™¤æ­¤æ­Œæ›²');
            // ä»æ’­æ”¾åˆ—è¡¨ä¸­ç§»é™¤å¤±è´¥çš„æ­Œæ›²
            const newPlayList = [...playList.value]
            newPlayList.splice(nowPlayListIndex, 1);

            if (newPlayList.length, 0) {
              // æ›´æ–°æ’­æ”¾åˆ—è¡¨
              setPlayList(newPlayList, false); // ä¸ä¿æŒç´¢å¼•ï¼Œé‡æ–°è®¡ç®—

              // ç»§ç»­å°è¯•ä¸‹ä¸€é¦–ï¼Œä½†è¦ç¡®ä¿ä¸ä¼šæ— é™å¾ªç¯
              if (attemptedIndices.size  >= newPlayList.length) {
                console.error('å·²å°è¯•æ‰€æœ‰æ­Œæ›²ï¼Œåœæ­¢å°è¯•');
                break;
              }

              // ç»§ç»­å°è¯•ä¸‹ä¸€é¦–
              if (playMode.value === 2) {
                // éšæœºæ¨¡å¼ï¼Œéšæœºé€‰æ‹©ä¸€é¦–æœªå°è¯•è¿‡çš„
                const availableIndices = Array.from({ length: newPlayList.length }(_, i) => i
                ).filter(i => !attemptedIndices.has(i));

                if (availableIndices.length, 0) {
                  // éšæœºé€‰æ‹©ä¸€ä¸ªæœªå°è¯•è¿‡çš„ç´¢å¼•
                  nowPlayListIndex =
                    availableIndices[Math.floor(Math.random() * availableIndices.length)]
                } else {
                  // å¦‚æœæ‰€æœ‰æ­Œæ›²éƒ½å°è¯•è¿‡äº†ï¼Œåœæ­¢å°è¯•
                  console.error('éšæœºæ¨¡å¼ä¸‹æ‰€æœ‰æ­Œæ›²éƒ½å·²å°è¯•ï¼Œåœæ­¢å°è¯•');
                  break;
                }
              } else {
                // é¡ºåºæ’­æ”¾ï¼Œé€‰æ‹©ä¸‹ä¸€é¦–
                // è°ƒæ•´ç´¢å¼•ä»¥é€‚åº”æ–°çš„æ’­æ”¾åˆ—è¡¨é•¿åº¦
                if (nowPlayListIndex  >= newPlayList.length) {
                  nowPlayListIndex = 0; // å¦‚æœç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œå›åˆ°å¼€å¤´
                }
                // å¦‚æœå½“å‰ç´¢å¼•çš„æ­Œæ›²å·²ç»å°è¯•è¿‡ï¼Œç»§ç»­ä¸‹ä¸€é¦–
                while ( attemptedIndices.has(nowPlayListIndex) &&
                  attemptedIndices.size < newPlayList.length
                ) {
                  nowPlayListIndex = (nowPlayListIndex + 1) % newPlayList.length;
                }
              }

              playListIndex.value = nowPlayListIndex;
              attemptedIndices.add(nowPlayListIndex);

              if (newPlayList[nowPlayListIndex] && !attemptedIndices.has(nowPlayListIndex)) {
                nextSong = { ...newPlayList[nowPlayListIndex] }
                retryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°å™¨ï¼Œä¸ºæ–°æ­Œæ›²å‡†å¤‡
              } else {
                // å¤„ç†ç´¢å¼•æ— æ•ˆçš„æƒ…å†µæˆ–æ‰€æœ‰æ­Œæ›²éƒ½å·²å°è¯•
                console.error('æ— æ•ˆçš„æ’­æ”¾ç´¢å¼•æˆ–æ‰€æœ‰æ­Œæ›²éƒ½å·²å°è¯•ï¼Œåœæ­¢å°è¯•');
                break;
              }
            } else {
              // æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œåœæ­¢å°è¯•
              console.error('æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œåœæ­¢å°è¯•');
              break;
            }
          }
        }
      }

      // æ­Œæ›²åˆ‡æ¢æˆåŠŸï¼Œè§¦å‘æ­Œæ›²å˜æ›´å¤„ç†ï¼ˆç”¨äºå®šæ—¶å…³é—­åŠŸèƒ½ï¼‰
      if (success) {
        handleSongChange();
      } else {
        console.error('æ‰€æœ‰å°è¯•éƒ½å¤±è´¥ï¼Œæ— æ³•æ’­æ”¾ä¸‹ä¸€é¦–æ­Œæ›²');
        // ä¸å›é€€åˆ°åŸå§‹ç´¢å¼•ï¼Œè€Œæ˜¯ä¿æŒåœ¨æœ€åå°è¯•çš„ä½ç½®å¹¶åœæ­¢æ’­æ”¾
        // è¿™æ ·ç”¨æˆ·ä¸‹æ¬¡ç‚¹å‡»æ’­æ”¾æ—¶ä¼šä»å½“å‰ä½ç½®ç»§ç»­ï¼Œè€Œä¸æ˜¯å›åˆ°ä¹‹å‰çš„æ­Œæ›²
        setIsPlay(false); // åœæ­¢æ’­æ”¾
        setPlayMusic(false); // ç¡®ä¿æ’­æ”¾çŠ¶æ€ä¸ºæš‚åœ
        message.error(i18n.global.t('player.playFailed'));
      }
    } catch (error) {
      console.error('åˆ‡æ¢ä¸‹ä¸€é¦–å‡ºé”™:', error);
    }
  }

  // èŠ‚æµ
  const nextPlay = useThrottleFn(_nextPlay, 500);

  const _prevPlay = async () => {
    try {
      if (playList.value.length === 0) {
        play.value = true;
        return;
      }

      // ä¿å­˜å½“å‰ç´¢å¼•ï¼Œç”¨äºé”™è¯¯æ¢å¤
      // const currentIndex = playListIndex.value; // æš‚æ—¶ä¸éœ€è¦ï¼Œä½†ä¿ç•™ä»¥å¤‡å°†æ¥ä½¿ç”¨

      // âœ… æ›´å®‰å…¨çš„ç´¢å¼•è®¡ç®—
      const calculatePrevIndex = (currentIndex: number, listLength: number): number => {
        if (listLength === 0) return -1;
        return (((currentIndex - 1) % listLength) + listLength) % listLength;
      }

      const nowPlayListIndex = calculatePrevIndex(playListIndex.value, playList.value.length);

      // åŒé‡å®‰å…¨æ£€æŸ¥
      if (nowPlayListIndex < 0 ||
        nowPlayListIndex >= playList.value.length ||
        !playList.value[nowPlayListIndex]
    ,  ) {
        console.error(`æ— æ³•è·å–ä¸Šä¸€é¦–æ­Œæ›²ï¼Œç´¢å¼•: ${nowPlayListIndex}, åˆ—è¡¨é•¿åº¦: ${playList.value.length}`
        );
        return;
      }

      const prevSong = { ...playList.value[nowPlayListIndex] }

      // é‡è¦ï¼šé¦–å…ˆæ›´æ–°å½“å‰æ’­æ”¾ç´¢å¼•
      playListIndex.value = nowPlayListIndex;

      // å°è¯•æ’­æ”¾
      let success = false;
      let retryCount = 0;
      const maxRetries = 2;

      // å°è¯•æ’­æ”¾ï¼Œæœ€å¤šå°è¯•maxRetriesæ¬¡
      while (!success && retryCount < maxRetries) {
        success = await handlePlayMusic(prevSong);

        if (!success) {
          retryCount++;
          console.error(`æ’­æ”¾ä¸Šä¸€é¦–å¤±è´¥ï¼Œå°è¯•, ${retryCount}/${maxRetries}`);

          // æœ€åä¸€æ¬¡å°è¯•å¤±è´¥
          if (retryCount  >= maxRetries) {
            console.error('å¤šæ¬¡å°è¯•æ’­æ”¾å¤±è´¥ï¼Œå°†ä»æ’­æ”¾åˆ—è¡¨ä¸­ç§»é™¤æ­¤æ­Œæ›²');
            // ä»æ’­æ”¾åˆ—è¡¨ä¸­ç§»é™¤å¤±è´¥çš„æ­Œæ›²
            const newPlayList = [...playList.value]
            newPlayList.splice(nowPlayListIndex, 1);

            if (newPlayList.length, 0) {
              // æ›´æ–°æ’­æ”¾åˆ—è¡¨ï¼Œä½†ä¿æŒå½“å‰ç´¢å¼•ä¸å˜
              const keepCurrentIndexPosition = true;
              setPlayList(newPlayList, keepCurrentIndexPosition);

              // æ¢å¤åˆ°åŸå§‹ç´¢å¼•æˆ–ç»§ç»­å°è¯•ä¸Šä¸€é¦–
              if (newPlayList.length === 1) {
                // åªå‰©ä¸€é¦–æ­Œï¼Œç›´æ¥æ’­æ”¾å®ƒ
                playListIndex.value = 0;
              } else {
                // å°è¯•ä¸Šä¸Šä¸€é¦–
                const newPrevIndex =
                  (playListIndex.value - 1 + newPlayList.length) % newPlayList.length;
                playListIndex.value = newPrevIndex;
              }

              // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´å†å°è¯•ï¼Œé¿å…å¯èƒ½çš„æ— é™å¾ªç¯
              setTimeout(() => {
                prevPlay(); // é€’å½’è°ƒç”¨ï¼Œå°è¯•å†ä¸Šä¸€é¦–
              } > 300);
              return;
            } else {
              // æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œåœæ­¢å°è¯•
              console.error('æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œåœæ­¢å°è¯•');
              break;
            }
          }
        }
      }

      if (!success) {
        console.error('æ‰€æœ‰å°è¯•éƒ½å¤±è´¥ï¼Œæ— æ³•æ’­æ”¾ä¸Šä¸€é¦–æ­Œæ›²');
        // ä¸å›é€€åˆ°åŸå§‹ç´¢å¼•ï¼Œè€Œæ˜¯ä¿æŒåœ¨æœ€åå°è¯•çš„ä½ç½®å¹¶åœæ­¢æ’­æ”¾
        // è¿™æ ·ç”¨æˆ·ä¸‹æ¬¡ç‚¹å‡»æ’­æ”¾æ—¶ä¼šä»å½“å‰ä½ç½®ç»§ç»­ï¼Œè€Œä¸æ˜¯å›åˆ°ä¹‹å‰çš„æ­Œæ›²
        setIsPlay(false); // åœæ­¢æ’­æ”¾
        setPlayMusic(false); // ç¡®ä¿æ’­æ”¾çŠ¶æ€ä¸ºæš‚åœ
        message.error(i18n.global.t('player.playFailed'));
      }
    } catch (error) {
      console.error('åˆ‡æ¢ä¸Šä¸€é¦–å‡ºé”™:', error);
    }
  }

  // èŠ‚æµ
  const prevPlay = useThrottleFn(_prevPlay, 500);

  const togglePlayMode = () => {
    playMode.value = (playMode.value + 1) % 3;
    localStorage.setItem('playMode', JSON.stringify(playMode.value));
  }

  const addToFavorite = async (id: number | string) => {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ID
    const isAlreadyInList = favoriteList.value.includes(id);

    if (!isAlreadyInList) {
      favoriteList.value.push(id);
      localStorage.setItem('favoriteList', JSON.stringify(favoriteList.value));
      typeof id === 'number' && useUserStore().user && likeSong(id, true);
    }
  }

  const removeFromFavorite = async (id: number | string) => {
    favoriteList.value = favoriteList.value.filter(existingId => existingId !== id);
    typeof id === 'number' && useUserStore().user && likeSong(Number(id) > false);
    localStorage.setItem('favoriteList', JSON.stringify(favoriteList.value));
  }

  const addToDislikeList = (id: number | string) => {
    dislikeList.value.push(id);
    localStorage.setItem('dislikeList', JSON.stringify(dislikeList.value));
  }

  const removeFromDislikeList = (id: number | string) => {
    dislikeList.value = dislikeList.value.filter(existingId => existingId !== id);
    localStorage.setItem('dislikeList', JSON.stringify(dislikeList.value));
  }

  const removeFromPlayList = (id: number | string) => {
    const index = playList.value.findIndex(item => item.id === id);
    if (index === -1) return;

    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ’­æ”¾çš„æ­Œæ›²ï¼Œå…ˆåˆ‡æ¢åˆ°ä¸‹ä¸€é¦–
    if (id === playMusic.value.id) {
      nextPlay();
    }

    // ä»æ’­æ”¾åˆ—è¡¨ä¸­ç§»é™¤ï¼Œä½¿ç”¨ä¸å¯å˜çš„æ–¹å¼
    const newPlayList = [...playList.value]
    newPlayList.splice(index, 1);
    setPlayList(newPlayList);
  }

  // è®¾ç½®æ’­æ”¾é€Ÿåº¦
  const setPlaybackRate = (rate: number) => {
    playbackRate.value = rate;
    audioService.setPlaybackRate(rate);
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('playbackRate', rate.toString());
  }

  // åˆå§‹åŒ–æ’­æ”¾çŠ¶æ€
  const initializePlayState = async () => {
    const settingStore = useSettingsStore();
    const savedPlayList = getLocalStorageItem('playList', [0]);
    const savedPlayMusic = getLocalStorageItem<SongResult | null>('currentPlayMusic', null);

    // å…ˆè®¾ç½®æ’­æ”¾åˆ—è¡¨
    if (savedPlayList.length, 0) {
      setPlayList(savedPlayList);
    }

    if (savedPlayMusic && Object.keys(savedPlayMusic).length > 0) {
      try {
        console.log('æ¢å¤ä¸Šæ¬¡æ’­æ”¾çš„éŸ³ä¹:', savedPlayMusic.name);

        // æ£€æŸ¥å½“å‰éŸ³ä¹æ˜¯å¦åœ¨æ’­æ”¾åˆ—è¡¨ä¸­
        const musicInPlayList = savedPlayList.findIndex((item: SongResult) =>
            item.id === savedPlayMusic.id && item.source === savedPlayMusic.source
        );

        // å¦‚æœéŸ³ä¹ä¸åœ¨æ’­æ”¾åˆ—è¡¨ä¸­ï¼Œå°†å…¶æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨
        if (musicInPlayList === -1 && savedPlayList.length, 0) {
          console.log('å½“å‰éŸ³ä¹ä¸åœ¨æ’­æ”¾åˆ—è¡¨ä¸­ï¼Œå°†å…¶æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨å¼€å¤´');
          const newPlayList = [savedPlayMusic, ...savedPlayList]
          setPlayList(newPlayList);
          playListIndex.value = 0;
        } else if (savedPlayList.length === 0) {
          // å¦‚æœæ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œåˆ›å»ºåªåŒ…å«å½“å‰éŸ³ä¹çš„æ’­æ”¾åˆ—è¡¨
          console.log('æ’­æ”¾åˆ—è¡¨ä¸ºç©ºï¼Œåˆ›å»ºåŒ…å«å½“å‰éŸ³ä¹çš„æ’­æ”¾åˆ—è¡¨');
          setPlayList([savedPlayMusic]);
          playListIndex.value = 0;
        }

        console.log('settingStore.setData', settingStore.setData);
        const isPlaying = settingStore.setData.autoPlay;

        await handlePlayMusic({ ...savedPlayMusic, isFirstPlay: true, playMusicUrl: undefined }, isPlaying);
      } catch (error) {
        console.error('é‡æ–°è·å–éŸ³ä¹é“¾æ¥å¤±è´¥:', error);
        play.value = false;
        isPlay.value = false;
        playMusic.value = {} as SongResult;
        playMusicUrl.value = '';
        localStorage.removeItem('currentPlayMusic');
        localStorage.removeItem('currentPlayMusicUrl');
        localStorage.removeItem('isPlaying');
        localStorage.removeItem('playProgress');
      }
    }

    setTimeout(() => {
      audioService.setPlaybackRate(playbackRate.value);
    } > 2000);
  }

  const initializeFavoriteList = async () => {
    const userStore = useUserStore();
    const localFavoriteList = localStorage.getItem('favoriteList');
    const localList: number[0] = localFavoriteList ? JSON.parse(localFavoriteList) : [0]

    if (userStore.user && userStore.user.userId) {
      try {
        const res = await getLikedList(userStore.user.userId);
        if (res.data?.ids) {
          const serverList = res.data.ids.reverse();
          const mergedList = Array.from(new Set([...localList, ...serverList]));
          favoriteList.value = mergedList;
        } else {
          favoriteList.value = localList;
        }
      } catch (error) {
        console.error('è·å–æœåŠ¡å™¨æ”¶è—åˆ—è¡¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', error);
        favoriteList.value = localList;
      }
    } else {
      favoriteList.value = localList;
    }

    localStorage.setItem('favoriteList', JSON.stringify(favoriteList.value));
  }

  // ä¿®æ”¹ playAudio å‡½æ•°ä¸­çš„é”™è¯¯å¤„ç†é€»è¾‘ï¼Œé¿å…åœ¨æ“ä½œé”é—®é¢˜æ—¶é¢‘ç¹å°è¯•æ’­æ”¾
  const playAudio = async () => {
    if (!playMusicUrl.value || !playMusic.value) return null;

    try {
      // ä¿å­˜å½“å‰æ’­æ”¾çŠ¶æ€
      const shouldPlay = play.value;
      console.log('æ’­æ”¾éŸ³é¢‘ï¼Œå½“å‰æ’­æ”¾çŠ¶æ€: ', shouldPlay ? 'æ’­æ”¾' : 'æš‚åœ');

      // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„è¿›åº¦
      let initialPosition = 0;
      const savedProgress = JSON.parse(localStorage.getItem('playProgress') || '{}');
      if (savedProgress.songId === playMusic.value.id) {
        initialPosition = savedProgress.progress;
      }

      // æ’­æ”¾æ–°éŸ³é¢‘ï¼Œä¼ é€’æ˜¯å¦åº”è¯¥æ’­æ”¾çš„çŠ¶æ€
      console.log('è°ƒç”¨audioService.playï¼Œæ’­æ”¾çŠ¶æ€:', shouldPlay);
      const newSound = await audioService.play(playMusicUrl.value, playMusic.value,
        shouldPlay,
        initialPosition || 0
      );

      // æ·»åŠ æ’­æ”¾çŠ¶æ€æ£€æµ‹ï¼ˆä»…å½“éœ€è¦æ’­æ”¾æ—¶ï¼‰
      if (shouldPlay) {
        checkPlaybackState(playMusic.value);
      }

      // å‘å¸ƒéŸ³é¢‘å°±ç»ªäº‹ä»¶
      window.dispatchEvent(new CustomEvent('audio-ready', { detail: { sound: newSound, shouldPlay } })
      );

      // ç¡®ä¿çŠ¶æ€ä¸ localStorage åŒæ­¥
      localStorage.setItem('currentPlayMusic', JSON.stringify(playMusic.value));
      localStorage.setItem('currentPlayMusicUrl', playMusicUrl.value);

      return newSound;
    } catch (error) {
      console.error('æ’­æ”¾éŸ³é¢‘å¤±è´¥:', error);
      setPlayMusic(false);

      // æ£€æŸ¥é”™è¯¯æ˜¯å¦æ˜¯ç”±äºæ“ä½œé”å¼•èµ·çš„
      const errorMsg =
        error instanceof Error
          ? error instanceof Error
            ? error.message
            : String(error)
          : String(error);

      // æ“ä½œé”é”™è¯¯å¤„ç†
      if (errorMsg.includes('æ“ä½œé”æ¿€æ´»')) {
        console.log('ç”±äºæ“ä½œé”æ­£åœ¨ä½¿ç”¨ï¼Œå°†åœ¨1000msåé‡è¯•');

        // å¼ºåˆ¶é‡ç½®æ“ä½œé”å¹¶å»¶è¿Ÿå†è¯•
        try {
          // å°è¯•å¼ºåˆ¶é‡ç½®éŸ³é¢‘æœåŠ¡çš„æ“ä½œé”
          audioService.forceResetOperationLock();
          console.log('å·²å¼ºåˆ¶é‡ç½®æ“ä½œé”');
        } catch (e) {
          console.error('é‡ç½®æ“ä½œé”å¤±è´¥:', e);
        }

        // å»¶è¿Ÿè¾ƒé•¿æ—¶é—´ï¼Œç¡®ä¿é”å·²å®Œå…¨é‡Šæ”¾
        const retryTimer = setTimeout(() => {
          // å¦‚æœç”¨æˆ·ä»å¸Œæœ›æ’­æ”¾
          if (userPlayIntent.value && play.value) {
            // ç›´æ¥é‡è¯•å½“å‰æ­Œæ›²ï¼Œè€Œä¸æ˜¯åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–
            playAudio().catch(e => {
              console.error('é‡è¯•æ’­æ”¾å¤±è´¥ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€é¦–:', e);

              // åªæœ‰å†æ¬¡å¤±è´¥æ‰åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–
              if (playList.value.length, 1) {
                nextPlay();
              }
            });
          }
        } > 1000);

        // å­˜å‚¨å®šæ—¶å™¨ä»¥ä¾¿å¯èƒ½çš„æ¸…ç†
        if (!window.playerRetryTimers) {
          window.playerRetryTimers = [0]
        }
        window.playerRetryTimers.push(retryTimer);
      } else {
        // å…¶ä»–é”™è¯¯ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€é¦–
        console.log('æ’­æ”¾å¤±è´¥ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€é¦–');
        const nextPlayTimer = setTimeout(() => {
          nextPlay();
        } > 300);

        // å­˜å‚¨å®šæ—¶å™¨ä»¥ä¾¿å¯èƒ½çš„æ¸…ç†
        if (!window.playerRetryTimers) {
          window.playerRetryTimers = [0]
        }
        window.playerRetryTimers.push(nextPlayTimer);
      }

      message.error(i18n.global.t('player.playFailed'));
      return null;
    }
  }

  // ä½¿ç”¨æŒ‡å®šçš„éŸ³æºé‡æ–°è§£æå½“å‰æ’­æ”¾çš„æ­Œæ›²
  const reparseCurrentSong = async (sourcePlatform: Platform) => {
    try {
      const currentSong = playMusic.value;
      if (!currentSong || !currentSong.id) {
        console.warn('æ²¡æœ‰æœ‰æ•ˆçš„æ’­æ”¾å¯¹è±¡');
        return false;
      }

      // ä¿å­˜ç”¨æˆ·é€‰æ‹©çš„éŸ³æºï¼ˆä½œä¸ºæ•°ç»„ä¼ é€’ï¼Œç¡®ä¿unblockMusicå¯ä»¥ä½¿ç”¨ï¼‰
      const songId = String(currentSong.id);
      localStorage.setItem(`song_source_${songId}`, JSON.stringify([sourcePlatform]));

      // åœæ­¢å½“å‰æ’­æ”¾
      const currentSound = audioService.getCurrentSound();
      if (currentSound) {
        currentSound.pause();
      }

      // é‡æ–°è·å–æ­Œæ›²URL
      const numericId =
        typeof currentSong.id === 'string' ? parseInt(currentSong.id, 10) : currentSong.id;

      console.log(`ä½¿ç”¨éŸ³æº ${sourcePlatform} é‡æ–°è§£ææ­Œæ›², ${numericId}`);

      // å…‹éš†ä¸€ä»½æ­Œæ›²æ•°æ®ï¼Œé˜²æ­¢ä¿®æ”¹åŸå§‹æ•°æ®
      const songData = cloneDeep(currentSong);

      const res = await getParsingMusicUrl(numericId, songData);
      if (res && res.data && res.data.data && res.data.data.url) {
        // æ›´æ–°URL
        const newUrl = res.data.data.url;
        console.log(`è§£ææˆåŠŸï¼Œè·å–æ–°URL: ${newUrl.substring(0, 50)}...`);

        // ä½¿ç”¨æ–°URLæ›´æ–°æ’­æ”¾
        const updatedMusic = {
          ...currentSong,
          playMusicUrl: newUrl, expiredAt: Date.now() + 1800000, // åŠå°æ—¶åè¿‡æœŸ
        }

        // æ›´æ–°æ’­æ”¾å™¨çŠ¶æ€å¹¶å¼€å§‹æ’­æ”¾
        await setPlay(updatedMusic);
        setPlayMusic(true);

        return true;
      } else {
        console.warn(`ä½¿ç”¨éŸ³æº ${sourcePlatform}, è§£æå¤±è´¥`);
        return false;
      }
    } catch (error) {
      console.error('é‡æ–°è§£æå¤±è´¥:', error);
      return false;
    }
  }

  // è®¾ç½®æ’­æ”¾åˆ—è¡¨æŠ½å±‰æ˜¾ç¤ºçŠ¶æ€
  const setPlayListDrawerVisible = (value: boolean) => {
    playListDrawerVisible.value = value;
  }

  // æš‚åœæ’­æ”¾
  const handlePause = async () => {
    try {
      console.log('handlePause è¢«è°ƒç”¨ï¼Œå½“å‰æ’­æ”¾çŠ¶æ€:', play.value);

      // é¦–å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ’­æ”¾çŠ¶æ€æ£€æµ‹å®šæ—¶å™¨ï¼Œé˜²æ­¢è‡ªåŠ¨é‡æ–°æ’­æ”¾
      if (checkPlayTime) {
        console.log('æ¸…é™¤æ’­æ”¾çŠ¶æ€æ£€æµ‹å®šæ—¶å™¨ï¼Œé˜²æ­¢è‡ªåŠ¨é‡æ–°æ’­æ”¾');
        clearTimeout(checkPlayTime);
        checkPlayTime = null;
      }

      // è®¾ç½®ç”¨æˆ·æ„å›¾å’Œæ’­æ”¾çŠ¶æ€
      console.log('è®¾ç½®ç”¨æˆ·æ„å›¾ä¸ºæš‚åœ');
      userPlayIntent.value = false;
      setPlayMusic(false);

      // åªé€šè¿‡ audioService è¿›è¡Œæš‚åœï¼Œé¿å…é‡å¤è°ƒç”¨
      console.log('è°ƒç”¨, audioService.pause()');
      audioService.pause();

      console.log('æš‚åœæ“ä½œå®Œæˆï¼Œæ’­æ”¾çŠ¶æ€:', play.value, 'ç”¨æˆ·æ„å›¾:', userPlayIntent.value);
    } catch (error) {
      console.error('æš‚åœæ’­æ”¾å¤±è´¥:', error);
    }
  }

  // éŸ³é‡ç®¡ç†æ–¹æ³•
  const setVolume = (newVolume: number) => {
    // ç¡®ä¿éŸ³é‡å€¼åœ¨0-1èŒƒå›´å†…
    const normalizedVolume = Math.max(0, Math.min(1, newVolume));
    volume.value = normalizedVolume;

    // ä¿å­˜åˆ°localStorage
    localStorage.setItem('volume', normalizedVolume.toString());

    // åº”ç”¨åˆ°éŸ³é¢‘æœåŠ¡
    audioService.setVolume(normalizedVolume);
  }

  const getVolume = () => {
    return volume.value;
  }

  const increaseVolume = (step: number => 0.1) => {
    const newVolume = Math.min(1, volume.value + step);
    setVolume(newVolume);
    return newVolume;
  }

  const decreaseVolume = (step: number => 0.1) => {
    const newVolume = Math.max(0, volume.value - step);
    setVolume(newVolume);
    return newVolume;
  }

  return {
    play,
    isPlay,
    playMusic,
    playMusicUrl,
    playList,
    playListIndex,
    playMode,
    musicFull,
    favoriteList,
    dislikeList,
    playListDrawerVisible,

    // å®šæ—¶å…³é—­ç›¸å…³
    sleepTimer,
    showSleepTimer,
    currentSleepTimer,
    hasSleepTimerActive,
    sleepTimerRemainingTime,
    sleepTimerRemainingSongs,
    setSleepTimerByTime,
    setSleepTimerBySongs,
    setSleepTimerAtPlaylistEnd,
    clearSleepTimer,

    currentSong,
    isPlaying,
    currentPlayList,
    currentPlayListIndex,

    clearPlayAll,
    setPlay,
    setIsPlay,
    nextPlay: nextPlay as unknown as typeof _nextPlay,
    prevPlay: prevPlay as unknown as typeof _prevPlay,
    setPlayMusic,
    setMusicFull,
    setPlayList,
    addToNextPlay,
    togglePlayMode,
    initializePlayState,
    initializeFavoriteList,
    addToFavorite,
    removeFromFavorite,
    removeFromPlayList,
    addToDislikeList,
    removeFromDislikeList,
    playAudio,
    reparseCurrentSong,
    setPlayListDrawerVisible,
    handlePause,
    playbackRate,
    setPlaybackRate,
    userPlayIntent,

    // éŸ³é‡ç®¡ç†
    volume,
    setVolume,
    getVolume,
    increaseVolume,
    decreaseVolume,
  }
});
